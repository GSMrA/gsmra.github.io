<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>GeekSoft - Admin Devis Response</title>
  <style>
    body { font-family: Arial, sans-serif; background: #0a0a0b; color: #fff; padding: 20px; }
    .container { max-width: 1200px; margin: 0 auto; }
    .login-box { max-width: 400px; margin: 50px auto; background: #1a1a1a; padding: 30px; border-radius: 12px; }
    .hidden { display: none; }
    table { width: 100%; background: #1a1a1a; border-radius: 12px; border-collapse: collapse; margin-top: 32px; }
    th, td { padding: 14px; }
    th { background: #2a2a2a; }
    tr { cursor: pointer; }
    tr:hover { background: #222; }
    button, .montant-btn { margin-top: 4px; padding: 12px; background: #32c1ff; color: #000; border: none; border-radius: 6px; font-size: 1.05rem; font-weight: bold; cursor: pointer;}
    button:hover, .montant-btn:hover { background: #fff; color: #000;}
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); align-items: center; justify-content: center; }
    .modal.show { display: flex; }
    .modal-content { background: #1a1a1a; padding: 30px; border-radius: 12px; max-width: 650px; width: 99%; position: relative; }
    .close { position: absolute; top: 10px; right: 20px; font-size: 2rem; cursor: pointer; color: #aaa; }
    .close:hover { color: #fff; }
    .form-group { margin-bottom: 18px; }
    .form-group label { display: block; color: #aaa; margin-bottom: 8px;}
    .form-group input, .form-group textarea { width:100%; padding:12px; background:#2a2a2a; border:1px solid #444; border-radius:6px; color:#fff;}
    .montant-list { margin-bottom: 14px;}
    .montant-row { display: flex; gap: 12px; align-items: center; margin-bottom:5px;}
    .montant-row input { flex: 1 1 60%; min-width: 0;}
    .montant-prix { max-width: 110px; }
    .danger { background: #ff6b6b!important; color:#000;}
    .success { background: #51cf66!important; color: #000;}
    .message { margin-top: 16px; padding: 12px; border-radius: 6px; text-align: center; }
  </style>
</head>
<body>
<div class="container">
  <h1>GeekSoft – Réponse aux Devis</h1>
  <!-- LOGIN -->
  <div id="loginSection" class="login-box">
    <h2>Connexion Admin</h2>
    <div class="form-group">
      <label>ID Admin</label>
      <input type="text" id="idInput" placeholder="admin42">
    </div>
    <div class="form-group">
      <label>Mot de passe</label>
      <input type="password" id="mdpInput" placeholder="••••••••">
    </div>
    <button onclick="handleLogin()">Se connecter</button>
    <div id="loginMessage"></div>
  </div>

  <!-- TABLE DES DEVIS -->
  <div id="tableSection" class="hidden">
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Nom</th>
          <th>Prénom</th>
          <th>Email</th>
          <th>Bot</th>
          <th>Serveur</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</div>

<!-- MODAL REPONSE -->
<div id="responseModal" class="modal" onclick="closeResponseModal()">
  <div class="modal-content" onclick="event.stopPropagation()">
    <span class="close" onclick="closeResponseModal()">&times;</span>
    <h2>Envoyer une réponse au devis</h2>
    <form id="responseForm" onsubmit="event.preventDefault(); sendResponse();">
      <div class="form-group">
        <label>Message au client :</label>
        <textarea id="messageInput" rows="3" placeholder="Merci pour votre demande..."></textarea>
      </div>
      <div class="form-group">
        <label>Client :</label>
        <input type="text" id="factureNom" readonly>
      </div>
      <div class="form-group">
        <label>Articles & montants (€)&nbsp;<span style="font-weight:normal;font-size:0.95em;">(rajoute ou supprime des lignes)</span></label>
        <div id="montantList" class="montant-list"></div>
        <button type="button" class="montant-btn" onclick="addMontantRow()">+ Ajouter un montant</button>
      </div>
      <button type="submit">Envoyer la réponse + facture</button>
      <div id="responseMessage"></div>
    </form>
  </div>
</div>

<script>
  const API = 'https://devmra.pythonanywhere.com';
  let devisData = {};
  let currentEmail = "", currentClient = "";

  // Login
  async function handleLogin() {
    const id = document.getElementById('idInput').value.trim();
    const mdp = document.getElementById('mdpInput').value.trim();
    const msg = document.getElementById('loginMessage');
    msg.innerHTML = '<div class="message">Connexion...</div>';
    try {
      const res = await fetch(API + '/admin_devis', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id, mdp })
      });
      const data = await res.json();
      if (!res.ok || data.error) {
        msg.innerHTML = '<div class="message danger">Identifiants invalides</div>';
        return;
      }
      devisData = data;
      document.getElementById('loginSection').classList.add('hidden');
      document.getElementById('tableSection').classList.remove('hidden');
      fillTable(data);
    } catch (err) {
      msg.innerHTML = '<div class="message danger">Erreur réseau</div>';
    }
  }

  // Table
  function fillTable(data) {
    const tbody = document.getElementById('tbody');
    tbody.innerHTML = '';
    for (const [file, content] of Object.entries(data)) {
      const parsed = parseDevis(content);
      const row = tbody.insertRow();
      row.innerHTML = `
        <td>${parsed.ID || '?'}</td>
        <td>${parsed.Nom || '—'}</td>
        <td>${parsed.Prénom || '—'}</td>
        <td>${parsed.Email || '—'}</td>
        <td>${parsed['Nom du bot'] || '—'}</td>
        <td>${parsed['Nom du serveur'] || '—'}</td>
        <td><button type="button" onclick="openResponseModal('${parsed.Email}','${parsed.Nom}')">Répondre</button></td>
      `;
    }
  }

  function parseDevis(text) {
    const lines = text.split('\n').filter(l => l.trim());
    const obj = {};
    lines.forEach(line => {
      const idx = line.indexOf(' : ');
      if (idx > -1) {
        const key = line.substring(0, idx).trim();
        const val = line.substring(idx + 3).trim();
        obj[key] = val;
      }
    });
    return obj;
  }

  // Modal
  function openResponseModal(email, client) {
    currentEmail = email;
    currentClient = client;
    document.getElementById('responseModal').classList.add('show');
    document.getElementById('factureNom').value = client || '';
    clearMontantList();
    addMontantRow(); // ligne minimum par défaut
    document.getElementById('responseMessage').innerHTML = '';
    document.getElementById('messageInput').value = '';
  }
  function closeResponseModal() {
    document.getElementById('responseModal').classList.remove('show');
  }

  // Montant rows dynamiques
  function clearMontantList() {
    document.getElementById('montantList').innerHTML = '';
  }
  function addMontantRow(nom='', prix='') {
    const list = document.getElementById('montantList');
    const div = document.createElement('div');
    div.className = 'montant-row';

    const inputNom = document.createElement('input');
    inputNom.type = 'text'; inputNom.placeholder = 'Désignation';
    inputNom.value = nom;
    div.appendChild(inputNom);

    const inputPrix = document.createElement('input');
    inputPrix.type = 'number'; inputPrix.min="0"; inputPrix.step="0.01";
    inputPrix.placeholder = 'Prix (€)'; inputPrix.className="montant-prix";
    inputPrix.value = prix;
    div.appendChild(inputPrix);

    const btnDel = document.createElement('button');
    btnDel.type = 'button'; btnDel.textContent = 'x';
    btnDel.className = 'montant-btn danger';
    btnDel.onclick = function(){ div.remove(); };
    div.appendChild(btnDel);

    list.appendChild(div);
  }

  // ENVOI
  async function sendResponse() {
    const msg = document.getElementById('messageInput').value || "";
    const items = [];
    document.querySelectorAll('#montantList .montant-row').forEach(row => {
      const nom = row.children[0].value.trim();
      const prix = row.children[1].value.trim();
      if (nom && prix && !isNaN(parseFloat(prix))) items.push({nom, prix: parseFloat(prix)});
    });
    if(items.length === 0) {
      document.getElementById('responseMessage').innerHTML =
        '<div class="message danger">Au moins un montant doit être saisi.</div>';
      return;
    }
    document.getElementById('responseMessage').innerHTML = '<div class="message">Envoi...</div>';
    try {
      const res = await fetch(API + '/send_response', {
        method: "POST",
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          email: currentEmail,
          message: msg,
          client: currentClient,
          items: items
        })
      });
      const data = await res.json();
      if (data.status === "sent") {
        document.getElementById('responseMessage').innerHTML =
          '<div class="message success">Réponse envoyée !</div>';
      } else {
        document.getElementById('responseMessage').innerHTML =
          '<div class="message danger">Erreur : ' + (data.msg || 'Envoi refused') + '</div>';
      }
    } catch (err) {
      document.getElementById('responseMessage').innerHTML =
        '<div class="message danger">Erreur réseau</div>';
    }
  }
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Puissance 4 - ULTRA COLLECTION</title>
    <style>
        :root {
            --cell-size: 55px;
            --p1-color: #ffcc00; /* Jaune */
            --p2-color: #ff3b30; /* Rouge */
            --wall-color: #7f8c8d;
            --bonus-color: #00ffaa;
            --bg-grad: radial-gradient(circle at center, #2b32b2 0%, #1488cc 100%);
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg-grad);
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
            touch-action: manipulation;
            user-select: none;
        }

        /* --- MENU --- */
        #menu-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            z-index: 100;
            animation: fadeIn 0.8s ease-out;
        }

        h1 {
            font-size: 3rem;
            text-transform: uppercase;
            text-shadow: 0 5px 15px rgba(0,0,0,0.5);
            margin-bottom: 20px;
            background: linear-gradient(to right, #ffcc00, #ff3b30);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: floatTitle 3s infinite ease-in-out;
        }

        .menu-btn {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 18px 40px;
            font-size: 1.2rem;
            border-radius: 50px;
            cursor: pointer;
            width: 280px;
            transition: all 0.2s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .menu-btn:hover { transform: scale(1.05); background: rgba(255,255,255,0.2); }
        .menu-btn:active { transform: scale(0.95); }

        .menu-btn.chaos { border-left: 5px solid #00ffaa; }
        .menu-btn.classic { border-left: 5px solid #ffcc00; }
        .menu-btn.ai { border-left: 5px solid #ff3b30; }

        /* --- JEU --- */
        #game-screen {
            display: none;
            flex-direction: column;
            align-items: center;
            width: 100%;
            height: 100%;
            padding-top: 10px;
        }

        .top-ui {
            width: 90%;
            max-width: 500px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .back-btn {
            background: rgba(0,0,0,0.3);
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
        }

        /* --- MODE CHAOS UI --- */
        #chaos-panel {
            display: none;
            width: 100%;
            flex-direction: column;
            align-items: center;
        }
        .objectives-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        .obj-card {
            background: rgba(0,0,0,0.4);
            padding: 5px 10px;
            border-radius: 8px;
            font-size: 0.8rem;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
        }

        /* --- SCOREBOARD --- */
        .score-board {
            display: flex;
            gap: 30px;
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 15px;
            background: rgba(0,0,0,0.3);
            padding: 10px 30px;
            border-radius: 30px;
        }
        .p1-sc { color: var(--p1-color); }
        .p2-sc { color: var(--p2-color); }

        /* --- GRILLE --- */
        .board-container {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 20px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.4);
            backdrop-filter: blur(5px);
            position: relative;
        }

        .board {
            display: grid;
            grid-template-columns: repeat(7, var(--cell-size));
            grid-template-rows: repeat(6, var(--cell-size));
            gap: 8px;
        }

        .cell {
            width: var(--cell-size);
            height: var(--cell-size);
            background: rgba(0,0,0,0.25);
            border-radius: 50%;
            position: relative;
            cursor: pointer;
            box-shadow: inset 0 3px 8px rgba(0,0,0,0.5);
        }

        /* Bonus Chaos */
        .cell.bonus::after {
            content: "+2";
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-weight: bold;
            color: var(--bonus-color);
            animation: pulse 1s infinite;
            font-size: 1rem;
            pointer-events: none;
        }

        /* Jetons */
        .token {
            width: 100%; height: 100%;
            border-radius: 50%;
            position: absolute;
            top: 0; left: 0;
            transform: translateY(var(--drop-start));
            z-index: 10;
        }
        .token.p1 { background: radial-gradient(circle at 30% 30%, #fff 5%, var(--p1-color) 50%); box-shadow: 0 0 10px var(--p1-color); }
        .token.p2 { background: radial-gradient(circle at 30% 30%, #fff 5%, var(--p2-color) 50%); box-shadow: 0 0 10px var(--p2-color); }
        .token.wall { background: #555; border-radius: 4px; box-shadow: inset 0 0 10px black; border: 2px solid #888; }
        
        .token.falling { animation: dropBounce 0.6s cubic-bezier(0.5, 0, 0.5, 1.5) forwards; }
        .token.placed { transform: translateY(0); } /* Pour murs/bombes instantan√©s */

        /* --- POUVOIRS (CHAOS) --- */
        .powers-dock {
            display: none; /* Visible seulement en chaos */
            gap: 15px;
            margin-top: 20px;
            background: rgba(0,0,0,0.5);
            padding: 10px 20px;
            border-radius: 40px;
        }
        .pwr-btn {
            width: 60px; height: 60px;
            border-radius: 50%;
            border: 2px solid #555;
            background: #333;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            position: relative;
            transition: 0.2s;
        }
        .pwr-btn.active { border-color: #00ffaa; box-shadow: 0 0 15px #00ffaa; transform: scale(1.1); }
        .pwr-btn:disabled { opacity: 0.3; cursor: not-allowed; }
        .cost {
            position: absolute; bottom: -5px; right: -5px;
            background: red; font-size: 0.7rem; padding: 2px 5px; border-radius: 10px;
        }

        /* --- ANIMATIONS --- */
        @keyframes fadeIn { from {opacity:0;} to {opacity:1;} }
        @keyframes floatTitle { 0%,100%{transform:translateY(0);} 50%{transform:translateY(-10px);} }
        @keyframes dropBounce {
            0% { transform: translateY(var(--drop-start)); opacity: 1; }
            60% { transform: translateY(0); }
            80% { transform: translateY(-10px); }
            100% { transform: translateY(0); opacity: 1; }
        }
        @keyframes pulse { 0%{transform:translate(-50%,-50%) scale(1);} 50%{transform:translate(-50%,-50%) scale(1.2);} 100%{transform:translate(-50%,-50%) scale(1);} }
        
        /* Explosion */
        .explosion {
            position: absolute; width: 100%; height: 100%;
            background: radial-gradient(circle, orange, red, transparent);
            border-radius: 50%;
            animation: explode 0.4s forwards;
            z-index: 20;
        }
        @keyframes explode { 0%{transform:scale(0); opacity:1;} 100%{transform:scale(2.5); opacity:0;} }

    </style>
</head>
<body>

    <!-- MENU -->
    <div id="menu-screen">
        <h1>Puissance 4</h1>
        <button class="menu-btn classic" onclick="startGame('classic')">üë• Classique (2J)</button>
        <button class="menu-btn ai" onclick="startGame('ai')">ü§ñ Solo vs IA</button>
        <button class="menu-btn chaos" onclick="startGame('chaos')">üî• Mode CHAOS</button>
    </div>

    <!-- JEU -->
    <div id="game-screen">
        <div class="top-ui">
            <button class="back-btn" onclick="goHome()">‚Üê Menu</button>
            <div id="turn-display">Tour J1</div>
        </div>

        <!-- Section Sp√©cifique Chaos -->
        <div id="chaos-panel">
            <div class="objectives-bar" id="obj-bar">
                <!-- G√©n√©r√© par JS -->
            </div>
        </div>

        <div class="score-board" id="score-board" style="display:none;">
            <div class="p1-sc">J1: <span id="s1">0</span></div>
            <div class="p2-sc">J2: <span id="s2">0</span></div>
        </div>

        <div class="board-container">
            <div class="board" id="board"></div>
        </div>

        <!-- Pouvoirs Chaos -->
        <div class="powers-dock" id="powers-dock">
            <button class="pwr-btn" onclick="togglePower('bomb')" id="btn-bomb">üí£<span class="cost">2</span></button>
            <button class="pwr-btn" onclick="togglePower('bigbomb')" id="btn-bigbomb">üß®<span class="cost">5</span></button>
            <button class="pwr-btn" onclick="togglePower('wall')" id="btn-wall">üß±<span class="cost">3</span></button>
        </div>
    </div>

    <script>
        // CONFIG
        const ROWS = 6;
        const COLS = 7;
        const COSTS = { 'bomb': 2, 'bigbomb': 5, 'wall': 3 };
        
        // ETAT DU JEU
        let gameMode = ''; // 'classic', 'ai', 'chaos'
        let boardState = []; 
        let bonusState = [];
        let scores = {1:0, 2:0};
        let currentPlayer = 1;
        let gameActive = false;
        let selectedPower = null;
        let chaosTimer = null;

        // ELEMENT DOM
        const menuScreen = document.getElementById('menu-screen');
        const gameScreen = document.getElementById('game-screen');
        const boardEl = document.getElementById('board');
        const s1El = document.getElementById('s1');
        const s2El = document.getElementById('s2');
        const turnEl = document.getElementById('turn-display');
        
        // --- NAVIGATION ---
        function startGame(mode) {
            gameMode = mode;
            menuScreen.style.display = 'none';
            gameScreen.style.display = 'flex';
            
            // Reset UI
            document.getElementById('chaos-panel').style.display = (mode === 'chaos') ? 'flex' : 'none';
            document.getElementById('powers-dock').style.display = (mode === 'chaos') ? 'flex' : 'none';
            document.getElementById('score-board').style.display = (mode === 'chaos') ? 'flex' : 'none';
            
            initGame();
        }

        function goHome() {
            gameActive = false;
            clearInterval(chaosTimer);
            gameScreen.style.display = 'none';
            menuScreen.style.display = 'flex';
        }

        // --- INIT JEU ---
        function initGame() {
            boardState = Array(ROWS).fill().map(() => Array(COLS).fill(0));
            bonusState = Array(ROWS).fill().map(() => Array(COLS).fill(false));
            scores = {1:5, 2:5}; // Chaos start pts
            currentPlayer = 1;
            gameActive = true;
            selectedPower = null;

            if(gameMode === 'chaos') {
                renderObjectives();
                updateScores();
                clearInterval(chaosTimer);
                chaosTimer = setInterval(spawnBonus, 5000); // Bonus toutes les 5s
            } else {
                turnEl.innerText = "Tour du Joueur 1";
            }

            renderBoard();
        }

        // --- MOTEUR GRAPHIQUE ---
        function renderBoard() {
            boardEl.innerHTML = '';
            for(let r=0; r<ROWS; r++) {
                for(let c=0; c<COLS; c++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    cell.dataset.r = r;
                    cell.dataset.c = c;
                    
                    if(gameMode === 'chaos' && bonusState[r][c]) cell.classList.add('bonus');
                    
                    // Click handler
                    cell.onclick = () => handleClick(r, c);

                    // Contenu (Jeton)
                    const val = boardState[r][c];
                    if(val !== 0) {
                        const token = document.createElement('div');
                        token.className = `token placed ${getTypeClass(val)}`;
                        cell.appendChild(token);
                    }
                    boardEl.appendChild(cell);
                }
            }
        }

        function getTypeClass(val) {
            if(val===1) return 'p1';
            if(val===2) return 'p2';
            return 'wall';
        }

        // --- LOGIQUE JEU ---
        function handleClick(r, c) {
            if(!gameActive) return;
            if(gameMode === 'ai' && currentPlayer === 2) return; // Pas touche pendant tour IA

            // 1. GESTION POUVOIRS (CHAOS)
            if(gameMode === 'chaos' && selectedPower) {
                applyPower(r, c);
                return;
            }

            // 2. COUP NORMAL (Gravit√©)
            let targetRow = -1;
            for(let i=ROWS-1; i>=0; i--) {
                if(boardState[i][c] === 0) {
                    targetRow = i;
                    break;
                }
            }

            if(targetRow !== -1) {
                // Jouer le coup
                boardState[targetRow][c] = currentPlayer;
                animateDrop(targetRow, c, currentPlayer);

                // Logique apr√®s coup
                if(gameMode === 'chaos') {
                    if(bonusState[targetRow][c]) {
                        scores[currentPlayer] += 2;
                        bonusState[targetRow][c] = false;
                        showFloatText("BONUS +2", "#00ffaa");
                    }
                    checkChaosObjectives(currentPlayer);
                    updateScores();
                    nextTurn();
                } else {
                    // Classique / IA Check Victoire
                    if(checkWin(targetRow, c, currentPlayer)) {
                        gameActive = false;
                        turnEl.innerText = `VICTOIRE JOUEUR ${currentPlayer} ! üéâ`;
                        turnEl.style.color = '#00ffaa';
                        return;
                    }
                    nextTurn();
                }
            }
        }

        function animateDrop(row, col, player) {
            const cell = document.querySelector(`.cell[data-r='${row}'][data-c='${col}']`);
            // Supprimer ancien contenu si existe (pour refresh propre)
            cell.innerHTML = ''; 
            
            const token = document.createElement('div');
            token.className = `token ${player===1?'p1':'p2'}`;
            
            // Calcul hauteur chute
            const dropPx = -((row * 63) + 150); 
            token.style.setProperty('--drop-start', `${dropPx}px`);
            
            token.classList.add('falling');
            cell.appendChild(token);
        }

        function nextTurn() {
            currentPlayer = currentPlayer === 1 ? 2 : 1;
            
            // Update UI texte
            let name = `Joueur ${currentPlayer}`;
            if(gameMode === 'ai' && currentPlayer === 2) name = "IA";
            turnEl.innerText = `Tour de ${name}`;
            turnEl.style.color = (currentPlayer===1) ? 'var(--p1-color)' : 'var(--p2-color)';

            // IA Move
            if(gameMode === 'ai' && currentPlayer === 2 && gameActive) {
                setTimeout(aiPlay, 600);
            }
            
            // Refresh boutons pouvoirs
            if(gameMode === 'chaos') updatePowerButtons();
        }

        // --- IA ---
        function aiPlay() {
            // IA basique : Al√©atoire valide
            const validCols = [];
            for(let c=0; c<COLS; c++) if(boardState[0][c]===0) validCols.push(c);
            
            if(validCols.length > 0) {
                const pick = validCols[Math.floor(Math.random()*validCols.length)];
                handleClick(0, pick);
            }
        }

        // --- CHAOS SPECIFIC ---
        function togglePower(pwr) {
            if(scores[currentPlayer] < COSTS[pwr]) return;
            selectedPower = (selectedPower === pwr) ? null : pwr;
            
            // Visuel boutons
            document.querySelectorAll('.pwr-btn').forEach(b => b.classList.remove('active'));
            if(selectedPower) document.getElementById(`btn-${pwr}`).classList.add('active');
        }

        function applyPower(r, c) {
            scores[currentPlayer] -= COSTS[selectedPower];
            
            if(selectedPower === 'bomb') destroy(r, c);
            if(selectedPower === 'bigbomb') {
                destroy(r, c); destroy(r+1, c); destroy(r, c+1); destroy(r+1, c+1);
            }
            if(selectedPower === 'wall') {
                if(boardState[r][c] === 0) {
                    boardState[r][c] = 3; // Mur
                    renderBoard(); // Refresh pour voir le mur
                }
            }

            selectedPower = null;
            updatePowerButtons();
            updateScores();
            nextTurn();
        }

        function destroy(r, c) {
            if(r<ROWS && c<COLS && r>=0 && c>=0) {
                boardState[r][c] = 0;
                // Effet
                const cell = document.querySelector(`.cell[data-r='${r}'][data-c='${c}']`);
                if(cell) {
                    const boom = document.createElement('div');
                    boom.className = 'explosion';
                    cell.appendChild(boom);
                    setTimeout(()=>renderBoard(), 400); // Re-render apr√®s explosion
                }
            }
        }

        function spawnBonus() {
            // Random bonus
            let r = Math.floor(Math.random()*ROWS);
            let c = Math.floor(Math.random()*COLS);
            if(boardState[r][c] === 0) {
                bonusState[r][c] = true;
                // Refresh visuel juste de la case si possible, sinon tout
                const cell = document.querySelector(`.cell[data-r='${r}'][data-c='${c}']`);
                if(cell) cell.classList.add('bonus');
            }
        }

        function updateScores() {
            s1El.innerText = scores[1];
            s2El.innerText = scores[2];
            updatePowerButtons();
        }

        function updatePowerButtons() {
            document.getElementById('btn-bomb').disabled = scores[currentPlayer] < 2;
            document.getElementById('btn-bigbomb').disabled = scores[currentPlayer] < 5;
            document.getElementById('btn-wall').disabled = scores[currentPlayer] < 3;
            
            // Reset selection si on change de tour
            if(!gameActive) return;
            document.querySelectorAll('.pwr-btn').forEach(b => b.classList.remove('active'));
            selectedPower = null;
        }
        
        // Simuler des objectifs
        function renderObjectives() {
            const bar = document.getElementById('obj-bar');
            bar.innerHTML = `
                <div class="obj-card">Ligne 3 (+3pts)</div>
                <div class="obj-card">Carr√© (+5pts)</div>
            `;
        }
        
        function checkChaosObjectives(player) {
            // Version simplifi√©e : On donne 1 pt pour chaque alignement de 3
            // Pour faire un vrai syst√®me complexe, il faut analyser les shapes
            if(checkWin(0,0,player, 3)) { // Hack: checkWin modifi√©e ou simplifi√©e
                 // Ici on fait simple: +1 pt par tour surv√©cu ? Non
                 // +1 pt gratuit pour l'action
                 scores[player] += 1;
            }
        }
        
        // Check Win classique (4 align√©s)
        function checkWin(r, c, p, countNeed=4) {
            // Scan complet plateau (plus simple)
            // Horiz
            for(let r=0; r<ROWS; r++) {
                for(let c=0; c<COLS-3; c++) {
                    if(boardState[r][c]==p && boardState[r][c+1]==p && boardState[r][c+2]==p && boardState[r][c+3]==p) return true;
                }
            }
            // Vert
            for(let r=0; r<ROWS-3; r++) {
                for(let c=0; c<COLS; c++) {
                    if(boardState[r][c]==p && boardState[r+1][c]==p && boardState[r+2][c]==p && boardState[r+3][c]==p) return true;
                }
            }
            // Diag
             for(let r=0; r<ROWS-3; r++) {
                for(let c=0; c<COLS-3; c++) {
                    if(boardState[r][c]==p && boardState[r+1][c+1]==p && boardState[r+2][c+2]==p && boardState[r+3][c+3]==p) return true;
                    if(boardState[r+3][c]==p && boardState[r+2][c+1]==p && boardState[r+1][c+2]==p && boardState[r][c+3]==p) return true;
                }
            }
            return false;
        }

        function showFloatText(txt, col) {
            const el = document.createElement('div');
            el.innerText = txt;
            el.style.position='absolute'; el.style.top='20%'; el.style.left='50%';
            el.style.transform='translate(-50%, -50%)';
            el.style.fontSize='2rem'; el.style.fontWeight='bold'; el.style.color=col;
            el.style.textShadow='0 0 10px black';
            el.style.animation='floatTitle 1s ease-out forwards';
            document.body.appendChild(el);
            setTimeout(()=>el.remove(), 1000);
        }

    </script>
</body>
</html>

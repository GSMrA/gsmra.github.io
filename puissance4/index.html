<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Puissance 4 - CHAOS MODE</title>
    <style>
        :root {
            --cell-size: 55px;
            --p1-color: #ffcc00; /* Jaune */
            --p2-color: #ff3b30; /* Rouge */
            --wall-color: #7f8c8d; /* Gris BÃ©ton */
            --bonus-color: #00ffaa; /* Cyan Fluo */
            --bg-dark: #1e1e2e;
            --panel-bg: rgba(30, 30, 46, 0.9);
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background: radial-gradient(circle, #2b32b2, #1488cc);
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
            touch-action: none;
        }

        /* --- UI DU HAUT : OBJECTIFS --- */
        .top-bar {
            display: flex;
            justify-content: space-around;
            width: 100%;
            max-width: 600px;
            background: rgba(0,0,0,0.3);
            padding: 10px;
            border-radius: 0 0 20px 20px;
            margin-bottom: 10px;
        }

        .objective-card {
            background: rgba(255,255,255,0.1);
            padding: 5px 10px;
            border-radius: 10px;
            text-align: center;
            font-size: 0.8rem;
            border: 1px solid rgba(255,255,255,0.2);
            width: 30%;
        }
        .shape-preview {
            display: inline-grid;
            gap: 2px;
            margin-bottom: 5px;
        }
        .mini-cell {
            width: 10px; height: 10px;
            background: rgba(255,255,255,0.3);
            border-radius: 50%;
        }
        .mini-cell.active { background: #ffd700; box-shadow: 0 0 5px #ffd700; }

        /* --- SCORES --- */
        .score-board {
            display: flex;
            justify-content: space-between;
            width: 90%;
            max-width: 450px;
            margin: 10px 0;
            font-size: 1.2rem;
            font-weight: bold;
        }
        .p1-score { color: var(--p1-color); text-shadow: 0 0 10px rgba(255,204,0,0.5); }
        .p2-score { color: var(--p2-color); text-shadow: 0 0 10px rgba(255,59,48,0.5); }

        /* --- GRILLE DE JEU --- */
        .board-container {
            background: rgba(0,0,0,0.4);
            padding: 15px;
            border-radius: 20px;
            position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .board {
            display: grid;
            grid-template-columns: repeat(7, var(--cell-size));
            grid-template-rows: repeat(6, var(--cell-size));
            gap: 8px;
        }

        .cell {
            width: var(--cell-size);
            height: var(--cell-size);
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
            position: relative;
            cursor: pointer;
        }
        
        /* Bonus case lumineuse */
        .cell.bonus::after {
            content: "+2";
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--bonus-color);
            text-shadow: 0 0 5px black;
            animation: pulse 1s infinite;
        }

        @keyframes pulse { 0%{transform:translate(-50%,-50%) scale(1);} 50%{transform:translate(-50%,-50%) scale(1.2);} 100%{transform:translate(-50%,-50%) scale(1);} }

        /* Jeton */
        .token {
            width: 100%; height: 100%;
            border-radius: 50%;
            position: absolute;
            top: 0; left: 0;
            transform: scale(0);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 2;
        }
        .token.p1 { background: radial-gradient(circle at 30% 30%, #fff, var(--p1-color)); }
        .token.p2 { background: radial-gradient(circle at 30% 30%, #fff, var(--p2-color)); }
        .token.wall { 
            background: #555; 
            border-radius: 5px; /* CarrÃ© pour le mur */
            box-shadow: inset 0 0 10px black;
            border: 2px solid #999;
        }
        .token.placed { transform: scale(1); }

        /* Effet explosion */
        .explosion {
            position: absolute;
            width: 100%; height: 100%;
            background: orange;
            border-radius: 50%;
            animation: explode 0.4s forwards;
            z-index: 10;
        }
        @keyframes explode { 0%{transform:scale(0); opacity:1;} 100%{transform:scale(2); opacity:0;} }

        /* --- POWERS --- */
        .powers-panel {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            background: rgba(0,0,0,0.6);
            padding: 10px 20px;
            border-radius: 50px;
        }

        .power-btn {
            background: #333;
            border: 2px solid #555;
            color: white;
            border-radius: 50%;
            width: 60px; height: 60px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: 0.2s;
            position: relative;
        }
        .power-btn.active { border-color: #00ffaa; box-shadow: 0 0 15px #00ffaa; transform: scale(1.1); }
        .power-btn:disabled { opacity: 0.3; cursor: not-allowed; }
        
        .cost-badge {
            font-size: 0.7rem;
            background: red;
            padding: 2px 5px;
            border-radius: 10px;
            position: absolute;
            bottom: -5px;
        }
        .power-icon { font-size: 1.2rem; margin-bottom: 2px; }

        /* Indicateur de tour */
        .turn-indicator {
            margin-top: 10px;
            font-size: 1rem;
            color: #ccc;
        }

    </style>
</head>
<body>

    <!-- UI HAUT : FORMES A REALISER -->
    <div class="top-bar" id="objectives">
        <!-- Rempli par JS -->
    </div>

    <!-- SCORES -->
    <div class="score-board">
        <div class="p1-score">J1: <span id="s1">0</span> pts</div>
        <div class="p2-score">J2: <span id="s2">0</span> pts</div>
    </div>

    <!-- PLATEAU -->
    <div class="board-container">
        <div class="board" id="board"></div>
    </div>

    <!-- POUVOIRS -->
    <div class="turn-indicator" id="turnInfo">Tour de Joueur 1</div>
    <div class="powers-panel">
        <button class="power-btn" onclick="selectPower('bomb')" id="btn-bomb">
            <span class="power-icon">ðŸ’£</span>
            <span class="cost-badge">2 pts</span>
        </button>
        <button class="power-btn" onclick="selectPower('bigbomb')" id="btn-bigbomb">
            <span class="power-icon">ðŸ§¨</span>
            <span class="cost-badge">5 pts</span>
        </button>
        <button class="power-btn" onclick="selectPower('wall')" id="btn-wall">
            <span class="power-icon">ðŸ§±</span>
            <span class="cost-badge">3 pts</span>
        </button>
    </div>

    <script>
        const ROWS = 6;
        const COLS = 7;
        let boardState = []; // 0=vide, 1=J1, 2=J2, 3=Mur
        let bonusState = []; // true si bonus sur la case
        let scores = {1: 0, 2: 0};
        let currentPlayer = 1;
        let selectedPower = null; // null, 'bomb', 'bigbomb', 'wall'
        
        // DÃ©finition des Formes cibles (Objectifs)
        const SHAPES = [
            { id: 1, pts: 5, grid: [[1,1,1]], name: "Ligne 3" }, // Ligne de 3
            { id: 2, pts: 6, grid: [[1],[1],[1]], name: "Tour 3" }, // Colonne de 3
            { id: 3, pts: 8, grid: [[1,1],[1,1]], name: "CarrÃ©" }, // CarrÃ© 2x2
            { id: 4, pts: 10, grid: [[1,0],[1,1]], name: "L Petit" }, // Coin
        ];
        let currentObjectives = [];

        // CoÃ»ts
        const COSTS = { 'bomb': 2, 'bigbomb': 5, 'wall': 3 };

        function initGame() {
            boardState = Array(ROWS).fill().map(() => Array(COLS).fill(0));
            bonusState = Array(ROWS).fill().map(() => Array(COLS).fill(false));
            scores = {1: 5, 2: 5}; // On commence avec 5 pts pour tester les pouvoirs direct
            currentPlayer = 1;
            selectedPower = null;
            
            generateObjectives();
            renderBoard();
            updateUI();
            
            // Spawn bonus pÃ©riodique
            setInterval(spawnBonus, 8000); 
        }

        // --- GÃ‰NÃ‰RATION D'OBJECTIFS ---
        function generateObjectives() {
            const container = document.getElementById('objectives');
            container.innerHTML = '';
            currentObjectives = SHAPES.slice(0, 3); // Prend les 3 premiers pour l'exemple
            
            currentObjectives.forEach(shape => {
                const div = document.createElement('div');
                div.className = 'objective-card';
                // Mini grille visu
                let gridHtml = `<div class="shape-preview" style="grid-template-columns:repeat(${shape.grid[0].length}, 10px)">`;
                shape.grid.forEach(row => {
                    row.forEach(cell => {
                        gridHtml += `<div class="mini-cell ${cell?'active':''}"></div>`;
                    });
                });
                gridHtml += `</div><div>+${shape.pts} pts</div>`;
                div.innerHTML = gridHtml;
                container.appendChild(div);
            });
        }

        // --- MOTEUR DE JEU ---
        function renderBoard() {
            const board = document.getElementById('board');
            board.innerHTML = '';
            for(let r=0; r<ROWS; r++){
                for(let c=0; c<COLS; c++){
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    if(bonusState[r][c]) cell.classList.add('bonus');
                    cell.dataset.r = r;
                    cell.dataset.c = c;
                    cell.onclick = () => handleCellClick(r, c);
                    
                    // Afficher contenu
                    const val = boardState[r][c];
                    if(val !== 0) {
                        const token = document.createElement('div');
                        token.className = `token placed ${val===1?'p1':(val===2?'p2':'wall')}`;
                        cell.appendChild(token);
                    }
                    board.appendChild(cell);
                }
            }
        }

        function handleCellClick(r, c) {
            // Mode Pouvoir : on clique n'importe oÃ¹ (ciblage prÃ©cis)
            if(selectedPower) {
                applyPower(r, c);
                return;
            }

            // Mode Normal : GravitÃ© (on clique la colonne)
            // Trouver la case vide la plus basse
            let targetRow = -1;
            for(let i=ROWS-1; i>=0; i--) {
                if(boardState[i][c] === 0) {
                    targetRow = i;
                    break;
                }
            }

            if(targetRow !== -1) {
                placeToken(targetRow, c, currentPlayer);
                nextTurn();
            }
        }

        function placeToken(r, c, player) {
            boardState[r][c] = player;
            
            // RÃ©cup bonus
            if(bonusState[r][c]) {
                scores[player] += 2;
                bonusState[r][c] = false;
                showFloatText(r, c, "+2 pts!", "#00ffaa");
            }

            // VÃ©rif Formes
            checkShapes(player);
            
            renderBoard(); // Simple refresh pour ce prototype
        }

        // --- GESTION DES POUVOIRS ---
        function selectPower(power) {
            if(scores[currentPlayer] < COSTS[power]) return; // Pas assez de pts
            
            if(selectedPower === power) {
                selectedPower = null; // DÃ©sÃ©lection
            } else {
                selectedPower = power;
            }
            updateUI();
        }

        function applyPower(r, c) {
            const cost = COSTS[selectedPower];
            scores[currentPlayer] -= cost;

            if(selectedPower === 'bomb') {
                // DÃ©truit 1 case (remet Ã  0)
                if(boardState[r][c] !== 0) {
                    destroyCell(r, c);
                }
            } 
            else if(selectedPower === 'bigbomb') {
                // DÃ©truit 2x2 autour
                destroyCell(r, c);
                if(r+1<ROWS) destroyCell(r+1, c);
                if(c+1<COLS) destroyCell(r, c+1);
                if(r+1<ROWS && c+1<COLS) destroyCell(r+1, c+1);
            }
            else if(selectedPower === 'wall') {
                // Place un mur (gravitÃ© s'applique ou pas ? Disons qu'on peut placer un mur n'importe oÃ¹ vide)
                if(boardState[r][c] === 0) {
                    boardState[r][c] = 3; // 3 = Mur
                }
            }

            selectedPower = null;
            renderBoard();
            nextTurn();
        }

        function destroyCell(r, c) {
            boardState[r][c] = 0;
            // Effet visuel rapide
            const cell = document.querySelector(`.cell[data-r='${r}'][data-c='${c}']`);
            if(cell) {
                const boom = document.createElement('div');
                boom.className = 'explosion';
                cell.appendChild(boom);
            }
        }

        // --- VERIF FORMES (ALGO SIMPLIFIÃ‰) ---
        function checkShapes(player) {
            // Pour chaque forme, on scanne toute la grille pour voir si elle existe pour ce joueur
            currentObjectives.forEach(shape => {
                const h = shape.grid.length;
                const w = shape.grid[0].length;
                
                let found = false;
                
                for(let r=0; r <= ROWS-h; r++) {
                    for(let c=0; c <= COLS-w; c++) {
                        // VÃ©rif match
                        let match = true;
                        for(let i=0; i<h; i++) {
                            for(let j=0; j<w; j++) {
                                if(shape.grid[i][j] === 1) {
                                    if(boardState[r+i][c+j] !== player) match = false;
                                }
                            }
                        }
                        if(match) found = true;
                    }
                }

                if(found) {
                    // Pour Ã©viter de gagner des pts en boucle, on pourrait "consommer" les jetons
                    // Ici on donne juste les points et on avertit
                    // Dans un jeu complet, il faudrait marquer ces jetons comme "utilisÃ©s"
                    scores[player] += shape.pts;
                    showFloatText(0, 3, `Forme ComplÃ©tÃ©e ! +${shape.pts}`, "gold");
                    
                    // Petit reset de la forme (on supprime les jetons pour le fun/chaos ?)
                    // Optionnel : boardState[r][c] = 0...
                }
            });
        }

        function spawnBonus() {
            // Trouve une case vide au hasard
            let r, c;
            let tries = 0;
            do {
                r = Math.floor(Math.random() * ROWS);
                c = Math.floor(Math.random() * COLS);
                tries++;
            } while(boardState[r][c] !== 0 && tries < 50);

            if(boardState[r][c] === 0) {
                bonusState[r][c] = true;
                renderBoard();
            }
        }

        function nextTurn() {
            currentPlayer = currentPlayer === 1 ? 2 : 1;
            updateUI();
        }

        function updateUI() {
            document.getElementById('s1').innerText = scores[1];
            document.getElementById('s2').innerText = scores[2];
            document.getElementById('turnInfo').innerText = `Tour de Joueur ${currentPlayer}`;
            
            // Boutons pouvoirs
            document.querySelectorAll('.power-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.disabled = false;
            });

            if(selectedPower) {
                document.getElementById(`btn-${selectedPower}`).classList.add('active');
                document.getElementById('turnInfo').innerText = "CLIQUEZ SUR LA GRILLE POUR UTILISER LE POUVOIR";
            }

            // Griser si pas assez de thunes
            if(scores[currentPlayer] < 2) document.getElementById('btn-bomb').disabled = true;
            if(scores[currentPlayer] < 5) document.getElementById('btn-bigbomb').disabled = true;
            if(scores[currentPlayer] < 3) document.getElementById('btn-wall').disabled = true;
        }

        function showFloatText(r, c, text, color) {
            // CrÃ©er une div volante pour afficher les points
            const float = document.createElement('div');
            float.innerText = text;
            float.style.position = 'absolute';
            float.style.left = '50%';
            float.style.top = '20%';
            float.style.transform = 'translate(-50%, -50%)';
            float.style.color = color;
            float.style.fontWeight = 'bold';
            float.style.fontSize = '2rem';
            float.style.textShadow = '0 0 10px black';
            float.style.pointerEvents = 'none';
            float.style.animation = 'floatUp 1s forwards';
            document.body.appendChild(float);
            setTimeout(() => float.remove(), 1000);
        }
        
        // CSS anim floatUp
        const style = document.createElement('style');
        style.innerHTML = `@keyframes floatUp { to { top: 10%; opacity: 0; } }`;
        document.head.appendChild(style);

        initGame();

    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Puissance 4 Multi</title>
    <style>
        body { font-family: Arial; text-align: center; background: #e0e0e0; }
        #board { display: grid; grid-template-columns: repeat(7, 80px); gap: 10px; background: #0066cc; padding: 20px; border-radius: 10px; border: 10px solid #0055aa; margin: 20px auto; }
        .cell { width: 80px; height: 80px; background: white; border-radius: 50%; cursor: pointer; }
        .red { background: #ff4136 !important; }
        .yellow { background: #ffdc00 !important; }
        .status { width: 60px; height: 60px; border-radius: 50%; margin: 10px auto; box-shadow: inset -5px -5px 10px rgba(0,0,0,0.3); }
        .red-selected { background: #ff4136; }
        .yellow-selected { background: #ffdc00; }
        #message { font-size: 2rem; font-weight: bold; margin: 20px; }
        button { padding: 10px 20px; background: #060606; color: white; border: none; border-radius: 5px; font-size: 1rem; cursor: pointer; margin: 10px; }
        button:hover { background: #383938; }
        input { padding: 10px; font-size: 1rem; margin: 10px; }
        #gameArea { display: none; }
    </style>
</head>
<body>
    <h1>Puissance 4 Online</h1>
    <div id="lobby">
        <button onclick="hostRoom()">Héberger une room</button>
        <div>
            <input id="roomCode" placeholder="Code room (ex: ABC123)" maxlength="6">
            <input id="playerName" placeholder="Ton pseudo">
            <button onclick="joinRoom()">Rejoindre</button>
        </div>
        <div id="roomInfo"></div>
    </div>
    <div id="gameArea">
        <div id="status" class="status red-selected"></div>
        <div id="board"></div>
        <div id="message"></div>
        <button onclick="resetGame()">Reset</button>
    </div>

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
        const WS_URL = 'wss://devmra.pythonanywhere.com'; // Ton URL + port SocketIO si différent
        let socket, roomId, playerId, currentPlayer = 'red', gameBoard = Array(6).fill().map(() => Array(7).fill(null)), isGameOver = false;

        // Créer grille
        function createBoard() {
            const board = document.getElementById('board');
            board.innerHTML = '';
            for (let r = 0; r < 6; r++) {
                for (let c = 0; c < 7; c++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    cell.dataset.col = c;
                    cell.dataset.row = r;
                    cell.onclick = () => playMove(c);
                    board.appendChild(cell);
                }
            }
        }

        // Jouer coup (local + envoi serveur)
        function playMove(col) {
            if (isGameOver || currentPlayer !== getMyColor()) return;
            socket.emit('play', { room: roomId, col: col });
        }

        // Mettre à jour UI depuis serveur
        function updateCell(row, col, color) {
            const cell = document.querySelector(`[data-row="${row}"][data-col="${col}"]`);
            cell.classList.add(color);
            gameBoard[row][col] = color;
            document.getElementById('status').classList.remove('red-selected', 'yellow-selected');
            document.getElementById('status').classList.add(`${currentPlayer === 'red' ? 'yellow' : 'red'}-selected`);
        }

        // Trouver position valide (bas vers haut)
        function dropPiece(col, color) {
            for (let row = 5; row >= 0; row--) {
                if (!gameBoard[row][col]) {
                    updateCell(row, col, color);
                    return row;
                }
            }
            return -1;
        }

        // Vérifier victoire (simplifié)
        function checkWin(color) {
            // Horizontal, vertical, diagonal (logique complète comme [web:20])
            for (let r = 0; r < 6; r++) for (let c = 0; c < 4; c++) if (checkLine(gameBoard[r][c], color, (r,c), (0,1))) return true;
            for (let c = 0; c < 7; c++) for (let r = 0; r < 3; r++) if (checkLine(gameBoard[r][c], color, (1,0))) return true;
            // Diagonales...
            return false;
        }

        function checkLine(start, color, dr, dc) { /* Implémente check 4 alignés */ return false; } // À compléter de [page:0]

        function getMyColor() { return playerId === 'player1' ? 'red' : 'yellow'; } // Simplifié

        // Connexion SocketIO persistante
        function connect() {
            socket = io(WS_URL, { transports: ['websocket'] }); // Force WS constant
            socket.on('connect', () => console.log('Connecté WS'));
            socket.on('state', (data) => {
                currentPlayer = data.currentPlayer;
                // Update board from data.board (2D array)
                document.getElementById('message').textContent = data.message || '';
                isGameOver = data.gameOver || false;
            });
            socket.on('play', (data) => {
                const row = dropPiece(data.col, data.color);
                if (row !== -1 && checkWin(data.color)) {
                    document.getElementById('message').textContent = `${data.color.toUpperCase()} gagne!`;
                    isGameOver = true;
                }
            });
        }

        function hostRoom() {
            playerId = 'player1';
            roomId = 'room_' + Math.random().toString(36).substr(2, 6).toUpperCase();
            socket.emit('create_room', { room: roomId, player: playerId });
            document.getElementById('roomInfo').innerHTML = `Ton code room: <strong>${roomId}</strong> (partage-le!)`;
            showGame();
        }

        function joinRoom() {
            roomId = document.getElementById('roomCode').value.toUpperCase();
            const name = document.getElementById('playerName').value || 'Joueur2';
            playerId = 'player2';
            socket.emit('join_room', { room: roomId, player: playerId, name });
        }

        function showGame() {
            document.getElementById('lobby').style.display = 'none';
            document.getElementById('gameArea').style.display = 'block';
            createBoard();
        }

        function resetGame() {
            socket.emit('reset', { room: roomId });
            gameBoard = Array(6).fill().map(() => Array(7).fill(null));
            isGameOver = false;
            document.getElementById('message').textContent = '';
            createBoard();
        }

        // Init
        connect();
        createBoard();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Puissance 4 - CHAOS EDITION</title>
    <style>
        :root {
            --cell-size: 55px;
            --p1-color: #ffcc00; /* Jaune */
            --p2-color: #ff3b30; /* Rouge */
            --wall-color: #7f8c8d;
            --bonus-color: #00ffaa;
            --bg-grad: radial-gradient(circle at center, #1a2a6c, #b21f1f, #fdbb2d); /* Sunset Chaos */
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: #1e1e2e;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
            touch-action: manipulation;
            user-select: none;
        }

        /* --- MENU --- */
        #menu-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            z-index: 100;
            animation: fadeIn 0.8s ease-out;
        }

        h1 {
            font-size: 3.5rem;
            text-transform: uppercase;
            letter-spacing: 3px;
            margin-bottom: 30px;
            background: linear-gradient(to right, #ffcc00, #ff3b30);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 0 15px rgba(255, 60, 0, 0.5));
            animation: floatTitle 3s infinite ease-in-out;
        }

        .menu-btn {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            color: white;
            padding: 20px 50px;
            font-size: 1.3rem;
            border-radius: 15px;
            cursor: pointer;
            width: 300px;
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .menu-btn:hover { transform: scale(1.05) translateY(-3px); background: rgba(255,255,255,0.15); box-shadow: 0 10px 25px rgba(0,0,0,0.3); }
        .menu-btn.chaos { border-left: 6px solid #00ffaa; }
        .menu-btn.classic { border-left: 6px solid #ffcc00; }
        .menu-btn.ai { border-left: 6px solid #ff3b30; }

        /* --- JEU --- */
        #game-screen {
            display: none;
            flex-direction: column;
            align-items: center;
            width: 100%;
            height: 100%;
            padding-top: 10px;
        }

        .top-ui {
            width: 95%;
            max-width: 500px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .back-btn {
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: 0.2s;
        }
        .back-btn:hover { background: rgba(255,255,255,0.3); }

        #turn-display {
            font-size: 1.2rem;
            font-weight: bold;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        /* --- MODE CHAOS UI --- */
        #chaos-panel {
            display: none;
            width: 100%;
            flex-direction: column;
            align-items: center;
            margin-bottom: 5px;
        }
        .objectives-bar {
            display: flex;
            gap: 8px;
            margin-bottom: 5px;
        }
        .obj-card {
            background: rgba(0,0,0,0.6);
            padding: 5px 8px;
            border-radius: 8px;
            font-size: 0.7rem;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .mini-grid {
            display: grid;
            gap: 2px;
            margin-bottom: 3px;
        }
        .mini-cell { width: 6px; height: 6px; background: rgba(255,255,255,0.2); border-radius: 50%; }
        .mini-cell.fill { background: gold; box-shadow: 0 0 3px gold; }

        /* --- SCOREBOARD --- */
        .score-board {
            display: flex;
            gap: 40px;
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 10px;
            background: rgba(0,0,0,0.4);
            padding: 8px 25px;
            border-radius: 50px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .p1-sc { color: var(--p1-color); display: flex; align-items: center; gap: 5px; }
        .p2-sc { color: var(--p2-color); display: flex; align-items: center; gap: 5px; }
        .pts-badge { background: white; color: black; padding: 2px 6px; border-radius: 10px; font-size: 0.9rem; }

        /* --- GRILLE --- */
        .board-container {
            background: rgba(255, 255, 255, 0.08);
            padding: 15px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            position: relative;
        }

        .board {
            display: grid;
            grid-template-columns: repeat(7, var(--cell-size));
            grid-template-rows: repeat(6, var(--cell-size));
            gap: 8px;
        }

        .cell {
            width: var(--cell-size);
            height: var(--cell-size);
            background: rgba(0,0,0,0.3);
            border-radius: 50%;
            position: relative;
            cursor: pointer;
            box-shadow: inset 0 3px 8px rgba(0,0,0,0.6);
            transition: transform 0.1s;
        }
        .cell:active { transform: scale(0.95); }

        /* Bonus Chaos */
        .cell.bonus::after {
            content: "+2";
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-weight: 800;
            color: var(--bonus-color);
            animation: pulse 1s infinite;
            font-size: 1.1rem;
            pointer-events: none;
            text-shadow: 0 0 5px black;
        }

        /* Jetons */
        .token {
            width: 100%; height: 100%;
            border-radius: 50%;
            position: absolute;
            top: 0; left: 0;
            transform: translateY(var(--drop-start));
            z-index: 10;
        }
        .token.p1 { background: radial-gradient(circle at 35% 35%, #fff 5%, var(--p1-color) 55%); box-shadow: 0 0 15px rgba(255, 204, 0, 0.4); }
        .token.p2 { background: radial-gradient(circle at 35% 35%, #fff 5%, var(--p2-color) 55%); box-shadow: 0 0 15px rgba(255, 59, 48, 0.4); }
        .token.wall { 
            background: #4a5568; 
            border-radius: 6px; 
            box-shadow: inset 0 0 15px black, 0 0 5px rgba(255,255,255,0.2); 
            border: 2px solid #718096;
        }
        
        .token.falling { animation: dropBounce 0.5s cubic-bezier(0.5, 0, 0.5, 1.5) forwards; }
        .token.placed { transform: translateY(0); }

        /* --- POUVOIRS (CHAOS) --- */
        .powers-dock {
            display: none;
            gap: 20px;
            margin-top: 25px;
            background: rgba(0,0,0,0.6);
            padding: 10px 30px;
            border-radius: 50px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .pwr-btn {
            width: 65px; height: 65px;
            border-radius: 50%;
            border: 2px solid #444;
            background: #2d3436;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            position: relative;
            transition: 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .pwr-btn:hover:not(:disabled) { transform: translateY(-5px); border-color: white; }
        .pwr-btn.active { border-color: #00ffaa; box-shadow: 0 0 20px #00ffaa, inset 0 0 10px #00ffaa; transform: scale(1.1); }
        .pwr-btn:disabled { opacity: 0.3; cursor: not-allowed; filter: grayscale(1); }
        
        .cost {
            position: absolute; bottom: -5px; right: -5px;
            background: #e74c3c; font-size: 0.8rem; padding: 2px 6px; border-radius: 12px;
            font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        /* --- ANIMATIONS --- */
        @keyframes fadeIn { from {opacity:0; transform: translateY(20px);} to {opacity:1; transform: translateY(0);} }
        @keyframes floatTitle { 0%,100%{transform:translateY(0);} 50%{transform:translateY(-10px);} }
        @keyframes dropBounce {
            0% { transform: translateY(var(--drop-start)); opacity: 1; }
            60% { transform: translateY(0); }
            80% { transform: translateY(-15px); }
            100% { transform: translateY(0); opacity: 1; }
        }
        @keyframes pulse { 0%{transform:translate(-50%,-50%) scale(1);} 50%{transform:translate(-50%,-50%) scale(1.2);} 100%{transform:translate(-50%,-50%) scale(1);} }
        
        /* Explosion */
        .explosion {
            position: absolute; width: 100%; height: 100%;
            background: radial-gradient(circle, #f1c40f, #e74c3c, transparent 70%);
            border-radius: 50%;
            animation: explode 0.5s ease-out forwards;
            z-index: 20;
            pointer-events: none;
        }
        @keyframes explode { 0%{transform:scale(0); opacity:1;} 100%{transform:scale(3); opacity:0;} }

    </style>
</head>
<body>

    <!-- MENU -->
    <div id="menu-screen">
        <h1>Connect 4 Ultimate</h1>
        <button class="menu-btn classic" onclick="startGame('classic')"><span>üë•</span> Classique</button>
        <button class="menu-btn ai" onclick="startGame('ai')"><span>ü§ñ</span> Solo vs IA</button>
        <button class="menu-btn chaos" onclick="startGame('chaos')"><span>üî•</span> Mode CHAOS</button>
    </div>

    <!-- JEU -->
    <div id="game-screen">
        <div class="top-ui">
            <button class="back-btn" onclick="goHome()">‚Üê Menu</button>
            <div id="turn-display">Tour J1</div>
        </div>

        <!-- Section Chaos -->
        <div id="chaos-panel">
            <div class="objectives-bar" id="obj-bar">
                <!-- Objectifs JS -->
            </div>
            <div class="score-board">
                <div class="p1-sc">J1 <span class="pts-badge" id="s1">0</span></div>
                <div class="p2-sc">J2 <span class="pts-badge" id="s2">0</span></div>
            </div>
        </div>

        <div class="board-container">
            <div class="board" id="board"></div>
        </div>

        <!-- Pouvoirs Chaos -->
        <div class="powers-dock" id="powers-dock">
            <button class="pwr-btn" onclick="togglePower('bomb')" id="btn-bomb" title="D√©truit 1 case (2 pts)">
                üí£<span class="cost">2</span>
            </button>
            <button class="pwr-btn" onclick="togglePower('bigbomb')" id="btn-bigbomb" title="D√©truit zone 2x2 (5 pts)">
                üß®<span class="cost">5</span>
            </button>
            <button class="pwr-btn" onclick="togglePower('wall')" id="btn-wall" title="Pose un mur bloquant (3 pts)">
                üß±<span class="cost">3</span>
            </button>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const ROWS = 6;
        const COLS = 7;
        const COSTS = { 'bomb': 2, 'bigbomb': 5, 'wall': 3 };
        
        // Formes √† r√©aliser pour gagner des points (Statiques)
        const SHAPES = [
            { pts: 3, name: "Ligne 3", grid: [[1,1,1]] },
            { pts: 4, name: "Carr√©", grid: [[1,1],[1,1]] },
            { pts: 5, name: "Tour 3", grid: [[1],[1],[1]] }
        ];

        // --- ETAT ---
        let gameMode = ''; 
        let boardState = []; 
        let bonusState = [];
        let scores = {1:0, 2:0};
        let currentPlayer = 1;
        let gameActive = false;
        let selectedPower = null;
        let chaosTimer = null;

        // --- DOM ---
        const menuScreen = document.getElementById('menu-screen');
        const gameScreen = document.getElementById('game-screen');
        const boardEl = document.getElementById('board');
        const s1El = document.getElementById('s1');
        const s2El = document.getElementById('s2');
        const turnEl = document.getElementById('turn-display');
        const objBar = document.getElementById('obj-bar');
        
        // --- NAVIGATION ---
        function startGame(mode) {
            gameMode = mode;
            menuScreen.style.display = 'none';
            gameScreen.style.display = 'flex';
            
            // Setup UI selon mode
            const isChaos = (mode === 'chaos');
            document.getElementById('chaos-panel').style.display = isChaos ? 'flex' : 'none';
            document.getElementById('powers-dock').style.display = isChaos ? 'flex' : 'none';
            
            initGame();
        }

        function goHome() {
            gameActive = false;
            clearInterval(chaosTimer);
            gameScreen.style.display = 'none';
            menuScreen.style.display = 'flex';
        }

        // --- INIT ---
        function initGame() {
            boardState = Array(ROWS).fill().map(() => Array(COLS).fill(0));
            bonusState = Array(ROWS).fill().map(() => Array(COLS).fill(false));
            
            // En Chaos, on commence avec des points pour s'amuser direct
            scores = {1: 5, 2: 5};
            
            currentPlayer = 1;
            gameActive = true;
            selectedPower = null;

            if(gameMode === 'chaos') {
                renderObjectives();
                updateScores();
                clearInterval(chaosTimer);
                chaosTimer = setInterval(spawnBonus, 5000); 
                turnEl.innerText = "Tour Joueur 1 (Chaos)";
            } else {
                turnEl.innerText = "Tour du Joueur 1";
            }
            
            updateTurnColor();
            renderBoard();
        }

        // --- RENDU GRAPHIQUE ---
        function renderBoard() {
            boardEl.innerHTML = '';
            for(let r=0; r<ROWS; r++) {
                for(let c=0; c<COLS; c++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    cell.dataset.r = r;
                    cell.dataset.c = c;
                    
                    if(gameMode === 'chaos' && bonusState[r][c]) cell.classList.add('bonus');
                    
                    cell.onclick = () => handleClick(r, c);

                    const val = boardState[r][c];
                    if(val !== 0) {
                        const token = document.createElement('div');
                        token.className = `token placed ${getTypeClass(val)}`;
                        cell.appendChild(token);
                    }
                    boardEl.appendChild(cell);
                }
            }
        }

        function getTypeClass(val) {
            if(val===1) return 'p1';
            if(val===2) return 'p2';
            return 'wall';
        }

        // --- GAMEPLAY LOOP ---
        function handleClick(r, c) {
            if(!gameActive) return;
            if(gameMode === 'ai' && currentPlayer === 2) return; 

            // 1. ACTION POUVOIR (Chaos)
            if(gameMode === 'chaos' && selectedPower) {
                applyPower(r, c);
                // IMPORTANT : On ne fait PAS nextTurn() ici -> Action gratuite !
                // On met juste √† jour l'affichage
                updateScores();
                renderBoard(); 
                return; 
            }

            // 2. COUP CLASSIQUE (Gravit√©)
            let targetRow = -1;
            for(let i=ROWS-1; i>=0; i--) {
                if(boardState[i][c] === 0) {
                    targetRow = i;
                    break;
                }
            }

            if(targetRow !== -1) {
                // Poser le jeton
                boardState[targetRow][c] = currentPlayer;
                animateDrop(targetRow, c, currentPlayer);

                // Logique Chaos
                if(gameMode === 'chaos') {
                    // Ramasser Bonus
                    if(bonusState[targetRow][c]) {
                        scores[currentPlayer] += 2;
                        bonusState[targetRow][c] = false;
                        showFloatText("BONUS +2", "#00ffaa");
                    }

                    // V√©rifier Objectifs (Formes)
                    checkObjectives(currentPlayer);

                    // V√©rifier VICTOIRE (4 align√©s)
                    if(checkWin(targetRow, c, currentPlayer)) {
                        endGame(`VICTOIRE J${currentPlayer} !`);
                        return;
                    }
                    
                    updateScores();
                    nextTurn();
                } 
                // Logique Classique / IA
                else {
                    if(checkWin(targetRow, c, currentPlayer)) {
                        endGame(`VICTOIRE JOUEUR ${currentPlayer} !`);
                        return;
                    }
                    nextTurn();
                }
            }
        }

        // --- IA & LOGIQUE ---
        function nextTurn() {
            if(!gameActive) return;
            currentPlayer = currentPlayer === 1 ? 2 : 1;
            updateTurnColor();
            
            // IA joue
            if(gameMode === 'ai' && currentPlayer === 2) {
                turnEl.innerText = "L'IA r√©fl√©chit...";
                setTimeout(aiPlay, 800);
            }
        }

        function updateTurnColor() {
            let txt = (currentPlayer===1) ? "Tour Joueur 1" : "Tour Joueur 2";
            if(gameMode === 'ai' && currentPlayer === 2) txt = "IA";
            
            turnEl.innerText = txt;
            turnEl.style.color = (currentPlayer===1) ? 'var(--p1-color)' : 'var(--p2-color)';
            
            if(gameMode === 'chaos') updatePowerButtons();
        }

        function aiPlay() {
            // IA Simple : bloque ou joue al√©atoire
            const validCols = [];
            for(let c=0; c<COLS; c++) if(boardState[0][c]===0) validCols.push(c);
            
            if(validCols.length > 0) {
                const pick = validCols[Math.floor(Math.random()*validCols.length)];
                handleClick(0, pick);
            }
        }

        // --- CHAOS : POUVOIRS ---
        function togglePower(pwr) {
            if(scores[currentPlayer] < COSTS[pwr]) return;
            
            // Toggle selection
            if(selectedPower === pwr) selectedPower = null;
            else selectedPower = pwr;
            
            updatePowerButtons();
        }

        function applyPower(r, c) {
            scores[currentPlayer] -= COSTS[selectedPower];
            
            if(selectedPower === 'bomb') destroy(r, c);
            if(selectedPower === 'bigbomb') {
                destroy(r, c); destroy(r+1, c); destroy(r, c+1); destroy(r+1, c+1);
            }
            if(selectedPower === 'wall') {
                if(boardState[r][c] === 0) boardState[r][c] = 3;
            }

            // D√©s√©lectionner apr√®s usage
            selectedPower = null;
            updatePowerButtons();
        }

        function destroy(r, c) {
            if(r<ROWS && c<COLS && r>=0 && c>=0) {
                boardState[r][c] = 0;
                // Effet visuel
                const cell = document.querySelector(`.cell[data-r='${r}'][data-c='${c}']`);
                if(cell) {
                    const boom = document.createElement('div');
                    boom.className = 'explosion';
                    cell.appendChild(boom);
                }
            }
        }

        function updatePowerButtons() {
            document.querySelectorAll('.pwr-btn').forEach(b => {
                b.classList.remove('active');
                b.disabled = false;
            });
            
            // Disable si pas assez de points
            if(scores[currentPlayer] < 2) document.getElementById('btn-bomb').disabled = true;
            if(scores[currentPlayer] < 5) document.getElementById('btn-bigbomb').disabled = true;
            if(scores[currentPlayer] < 3) document.getElementById('btn-wall').disabled = true;

            // Active visual
            if(selectedPower) {
                document.getElementById(`btn-${selectedPower}`).classList.add('active');
                turnEl.innerText = "CIBLEZ UNE CASE !";
            }
        }

        // --- CHAOS : OBJECTIFS ---
        function renderObjectives() {
            objBar.innerHTML = '';
            SHAPES.forEach(shape => {
                let gridHtml = `<div class="mini-grid" style="grid-template-columns:repeat(${shape.grid[0].length}, 4px)">`;
                shape.grid.forEach(row => row.forEach(c => gridHtml += `<div class="mini-cell ${c?'fill':''}"></div>`));
                gridHtml += `</div>`;
                
                const card = document.createElement('div');
                card.className = 'obj-card';
                card.innerHTML = `${gridHtml}<div>${shape.name}</div><div style="color:gold">+${shape.pts}</div>`;
                objBar.appendChild(card);
            });
        }

        function checkObjectives(player) {
            // Simplifi√© pour d√©mo : On v√©rifie juste les lignes de 3 pour donner des points
            // Une impl√©mentation compl√®te scannerait les matrices
            // Pour que le jeu reste fluide, on donne un petit bonus si on fait une ligne de 3
            if(checkWin(0,0,player, 3)) { // 3 align√©s ?
                 // Astuce : on ne veut pas spammer les points, donc on ajoute un petit d√©lai
                 // Ou on consid√®re que c'est bon.
                 scores[player] += 3;
                 showFloatText("+3 PTS FORME !", "gold");
            }
        }

        function spawnBonus() {
            let r = Math.floor(Math.random()*ROWS);
            let c = Math.floor(Math.random()*COLS);
            if(boardState[r][c] === 0) {
                bonusState[r][c] = true;
                const cell = document.querySelector(`.cell[data-r='${r}'][data-c='${c}']`);
                if(cell) cell.classList.add('bonus');
            }
        }

        function updateScores() {
            s1El.innerText = scores[1];
            s2El.innerText = scores[2];
        }

        // --- UTILITAIRES ---
        function animateDrop(row, col, player) {
            const cell = document.querySelector(`.cell[data-r='${row}'][data-c='${col}']`);
            cell.innerHTML = ''; 
            const token = document.createElement('div');
            token.className = `token ${player===1?'p1':'p2'}`;
            // 63px = ~cell height + gap
            const dropPx = -((row * 63) + 120); 
            token.style.setProperty('--drop-start', `${dropPx}px`);
            token.classList.add('falling');
            cell.appendChild(token);
        }

        function checkWin(r, c, p, countNeed=4) {
            // Check Horizontal
            for(let r=0; r<ROWS; r++) {
                for(let c=0; c<=COLS-countNeed; c++) {
                    let match = true;
                    for(let k=0; k<countNeed; k++) if(boardState[r][c+k] !== p) match=false;
                    if(match) return true;
                }
            }
            // Check Vertical
            for(let c=0; c<COLS; c++) {
                for(let r=0; r<=ROWS-countNeed; r++) {
                    let match = true;
                    for(let k=0; k<countNeed; k++) if(boardState[r+k][c] !== p) match=false;
                    if(match) return true;
                }
            }
            // Check Diagonals
            // ... (Simplifi√© pour la d√©mo, la version compl√®te n√©cessite les boucles diag)
            // Diag Descendante
            for(let r=0; r<=ROWS-countNeed; r++){
                for(let c=0; c<=COLS-countNeed; c++){
                    let match = true;
                    for(let k=0; k<countNeed; k++) if(boardState[r+k][c+k] !== p) match=false;
                    if(match) return true;
                }
            }
             // Diag Montante
            for(let r=countNeed-1; r<ROWS; r++){
                for(let c=0; c<=COLS-countNeed; c++){
                    let match = true;
                    for(let k=0; k<countNeed; k++) if(boardState[r-k][c+k] !== p) match=false;
                    if(match) return true;
                }
            }
            return false;
        }

        function endGame(msg) {
            gameActive = false;
            clearInterval(chaosTimer);
            turnEl.innerText = `üèÜ ${msg}`;
            turnEl.style.fontSize = "1.5rem";
            turnEl.style.color = "#00ffaa";
            
            // F√™te
            for(let i=0; i<15; i++) {
                setTimeout(() => {
                    const r = Math.floor(Math.random()*ROWS);
                    const c = Math.floor(Math.random()*COLS);
                    destroy(r,c); // Reuse explosion logic
                }, i*150);
            }
        }

        function showFloatText(txt, col) {
            const el = document.createElement('div');
            el.innerText = txt;
            el.style.cssText = `position:absolute; top:20%; left:50%; transform:translate(-50%, -50%); 
                                font-size:2rem; font-weight:bold; color:${col}; text-shadow:0 0 10px black; 
                                animation:floatTitle 1.5s ease-out forwards; pointer-events:none; z-index:100;`;
            document.body.appendChild(el);
            setTimeout(()=>el.remove(), 1500);
        }

    </script>
</body>
</html>

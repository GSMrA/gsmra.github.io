<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GeekSoft - Liste des devis</title>
  <link rel="icon" type="image/png" href="GEEKSOFT.png">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --background: #0b0b0b;
      --text-main: #ffffff;
      --muted: #cccccc;
      --accent: #ffffff;
      --shadow: 0 0 25px rgba(255,255,255,0.2);
      --card-bg: #141414;
    }
    html, body {
      margin:0; font-family:'Poppins',sans-serif;
      background:var(--background); color:var(--text-main);
      display:flex; flex-direction:column; align-items:center;
      min-height:100vh; overflow-x:hidden;
    }
    .topbar {
      position:fixed; top:20px; left:50%;
      transform:translateX(-50%);
      background:#000; color:var(--text-main);
      padding:20px 30px; display:flex; align-items:center;
      justify-content:space-between; border-radius:18px;
      width:90%; max-width:900px;
      box-shadow:0 0 20px rgba(255,255,255,0.4); z-index:100;
    }
    .logo {height:55px; filter:drop-shadow(0 0 8px var(--accent));}
    .title {font-weight:700; font-size:2rem; letter-spacing:1.5px; text-transform:uppercase; color:var(--text-main); text-shadow:0 0 15px rgba(255,255,255,0.6); margin:0;}
    .spacer {height:120px;}
    table {
      width:98vw;
      max-width:1700px;
      border-collapse: collapse;
      margin: 30px auto 0 auto;
      background: #181818;
      border-radius: 16px;
      overflow: hidden;
      box-shadow:0 0 10px rgba(255,255,255,0.09);
    }
    th, td {
      padding: 16px 26px;
      text-align: left;
      font-size: 1.07rem;
    }
    th {color: var(--accent); background:#222222;}
    tr {
      transition: background 0.18s;
      cursor: pointer;
    }
    tr:hover { background: #23253a; }
    .muted{color:var(--muted);}
    .loader {
      width: 35px; aspect-ratio: 1;
      --_g: no-repeat radial-gradient(farthest-side,#000 94%,#0000);
      background:var(--_g) 0 0, var(--_g) 100% 0,
                 var(--_g) 100% 100%,var(--_g) 0 100%;
      background-size: 40% 40%;
      animation: l38 .5s infinite;
      margin: 40px auto 20px auto;
      display:block;
    }
    @keyframes l38 { 100% {background-position: 100% 0,100% 100%,0 100%,0 0} }
    .error { color: #ff8080; margin-top:24px; font-size:1.1rem;}
    .infos {
      background:var(--card-bg);
      border-radius:20px;
      padding:30px;
      width:96%;
      max-width:1100px; /* rectangle infos √âLARGI ! */
      box-shadow:var(--shadow);
      margin:30px auto;
      display: none;
      flex-direction: column;
      gap:14px;
      font-size:1.11rem;
      line-height:1.45em;
      transition:all 0.25s;
    }
    .infos.visible {display:flex;}
    .info-key {color:var(--muted);}
    .loader-small {
      width: 24px; aspect-ratio: 1;
      --_g: no-repeat radial-gradient(farthest-side,#000 94%,#0000);
      background:var(--_g) 0 0, var(--_g) 100% 0,
                var(--_g) 100% 100%,var(--_g) 0 100%;
      background-size: 40% 40%;
      animation: l38 .5s infinite;
      margin: 10px auto 10px auto;
      display:block;
    }
    .info-pre {
      margin-top:7px;
      background:#181818;
      border-radius:8px;
      padding:10px 14px;
      font-size:0.99em;
      white-space:pre-wrap;
      color:var(--accent);
      font-family: "Poppins", "Consolas", monospace;
    }
    .btn-area {
      display: flex;
      gap: 14px;
      margin-top: 16px;
      flex-wrap:wrap;
    }
    .btn {
      padding: 12px 20px;
      background: var(--accent);
      color: #000;
      font-weight: 600;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-family: inherit;
      font-size: 1.06rem;
      transition: background 0.15s;
    }
    .btn.red {
      background:#ff4444;
      color:white;
    }
    .btn:hover {
      background: #e6e6e6;
    }
    .btn.red:hover{background:#ff6262;}
    .success {
      color: #1fffab;
      margin-top: 16px;
      font-size: 1.05em;
    }
    @media (max-width:800px){
      .infos {max-width:98vw;width:98vw;}
      .topbar {max-width:98vw;width:98vw;}
      table, th, td {font-size:.98rem;}
      .btn-area {flex-direction:column;}
      .btn {width:100%;}
    }
  </style>
</head>
<body>
  <header class="topbar">
    <img src="GEEKSOFT.png" alt="GEEKSOFT" class="logo" />
    <div class="title">GEEKSOFT - LISTE DES DEVIS</div>
  </header>
  <div class="spacer"></div>
  <h2 style="margin-top:0;margin-bottom:16px;">Mes devis</h2>
  <div class="loader" id="loader"></div>
  <div class="error" id="error-msg" style="display:none"></div>
  <table id="devis-table" style="display:none;">
    <thead>
      <tr>
        <th>Nom du bot</th>
        <th>ID</th>
        <th>Dernier statut</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <div class="infos" id="devis-infos"></div>
  <script>
    function statusLabel(val) {
      switch(val) {
        case 'RECU': return "Re√ßu";
        case 'LU': return "Lu";
        case 'APPROUVE': return "Approuv√©";
        case 'REPONCE': return "R√©pondu";
        default: return "Inconnu";
      }
    }
    function infoField(obj, key){
      return obj[key] || obj[key.toLowerCase()] || "<span class='muted'>(inconnu)</span>";
    }
    // POST pour set le statut
    async function updateDevisStatus(id, status) {
      try {
        const resp = await fetch(`https://devmra.pythonanywhere.com/setdevisstatus/${id}`, {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({status})
        });
        return await resp.json();
      } catch (e) {
        return {error: "Erreur de connexion √† l'API"};
      }
    }
    // DELETE pour supprimer le devis
    async function deleteDevis(id) {
      try {
        const resp = await fetch(`https://devmra.pythonanywhere.com/devisdelete/${id}`, {method:"DELETE"});
        return await resp.json();
      } catch(e) {
        return {error:"Erreur de connexion √† l'API"};
      }
    }
    window.addEventListener('DOMContentLoaded', async ()=>{
      const loader = document.getElementById('loader');
      const table = document.getElementById('devis-table');
      const error = document.getElementById('error-msg');
      const tbody = table.querySelector('tbody');
      const infos = document.getElementById('devis-infos');

      function showTable() {
        table.style.display = 'table';
        infos.style.display = 'none';
        document.querySelector('h2').textContent = "Mes devis";
      }

      try {
        const resp = await fetch('https://devmra.pythonanywhere.com/devislist');
        const data = await resp.json();
        if(!Array.isArray(data)) throw new Error("Format inattendu");
        if(data.length === 0) {
          error.textContent = "Aucun devis trouv√©.";
          error.style.display = 'block';
          loader.style.display = 'none';
          return;
        }
        data.forEach(devis=>{
          const tr = document.createElement('tr');
          tr.innerHTML =
            `<td>${devis.nom_bot ? devis.nom_bot : "<span class='muted'>(inconnu)</span>"}</td>` +
            `<td>${devis.id}</td>` +
            `<td>${statusLabel(devis.dernier_status_true)}</td>`;
          tr.onclick = async ()=>{
            table.style.display = 'none';
            document.querySelector('h2').textContent = "D√©tail du devis";
            infos.innerHTML = '<div class="loader-small"></div>';
            infos.classList.add('visible');
            infos.style.display = 'flex';
            // Statut LU
            await updateDevisStatus(devis.id, "LU");
            try {
              const resp2 = await fetch(`https://devmra.pythonanywhere.com/devisinfos/${devis.id}`);
              const data2 = await resp2.json();
              if(data2.error){
                infos.innerHTML = `<div class="error">Erreur : ${data2.error}</div>`;
              } else {
                infos.innerHTML = `
                  <div><span class="info-key">ID :</span> ${infoField(data2, "id")}</div>
                  <div><span class="info-key">Pr√©nom :</span> ${infoField(data2, "PRENOM")}</div>
                  <div><span class="info-key">Nom :</span> ${infoField(data2, "NOM")}</div>
                  <div><span class="info-key">Email :</span> ${infoField(data2, "EMAIL")}</div>
                  <div><span class="info-key">Nom du bot :</span> ${infoField(data2, "NOM_BOT")}</div>
                  <div><span class="info-key">Nombre de membres :</span> ${infoField(data2, "NOMBRE_MEMBRES")}</div>
                  <div><span class="info-key">Fonctionnalit√©s :</span> ${infoField(data2, "FONCTIONNALITES")}</div>
                  ${
                    data2.FICHIER_FONCTIONNALITES || data2.fichier_fonctionnalites
                    ? `<div><span class="info-key">R√©sum√© d√©taill√© :</span> 
                          <pre class="info-pre">${(data2.FICHIER_FONCTIONNALITES || data2.fichier_fonctionnalites).replace(/</g,'&lt;')}</pre>
                       </div>` : ""
                  }
                  <div class="btn-area">
                    <button class="btn" id="btn-back">Retour</button>
                    <button class="btn" id="btn-approve">Approuver</button>
                    <button class="btn red" id="btn-delete">Supprimer</button>
                  </div>
                  <div id="action-msg"></div>
                `;
                document.getElementById('btn-back').onclick = showTable;
                document.getElementById('btn-approve').onclick = async ()=>{
                  document.getElementById('action-msg').innerHTML = '<span class="loader-small"></span>';
                  const res = await updateDevisStatus(devis.id, "APPROUVE");
                  if(res.error){
                    document.getElementById('action-msg').innerHTML = `<div class="error">${res.error}</div>`;
                  } else {
                    document.getElementById('action-msg').innerHTML = `<div class="success">‚úÖ Le devis a √©t√© approuv√© !</div>`;
                  }
                };
                document.getElementById('btn-delete').onclick = async ()=>{
                  if(!confirm("Voulez-vous vraiment supprimer ce devis ?")) return;
                  document.getElementById('action-msg').innerHTML = '<span class="loader-small"></span>';
                  const res = await deleteDevis(devis.id);
                  if(res.error){
                    document.getElementById('action-msg').innerHTML = `<div class="error">${res.error}</div>`;
                  } else if(Array.isArray(res.deleted) && res.deleted.length > 0) {
                    document.getElementById('action-msg').innerHTML =
                      `<div class="success">üóëÔ∏è Devis supprim√© !<br/>(${res.deleted.join(", ")}) 
                        <br/><button class="btn" onclick="location.reload()">Retour √† la liste</button></div>`;
                  } else {
                    document.getElementById('action-msg').innerHTML = `<div class="error">Aucun fichier supprim√©.</div>`;
                  }
                };
              }
            } catch(err){
              infos.innerHTML = `<div class="error">Erreur de connexion ou format JSON invalide</div>`;
            }
          };
          tbody.appendChild(tr);
        });
        loader.style.display = 'none';
        table.style.display = 'table';
      } catch(err){
        error.textContent = "Erreur lors du chargement des devis.";
        error.style.display = 'block';
        loader.style.display = 'none';
      }
    });
  </script>
</body>
</html>

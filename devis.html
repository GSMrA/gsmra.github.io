<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GeekSoft - Paiement Devis</title>
  <link rel="icon" type="image/png" href="GEEKSOFT.png">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --background: #0b0b0b;
      --text-main: #ffffff;
      --muted: #cccccc;
      --accent: #ffffff;
      --card-bg: #141414;
      --shadow: 0 0 25px rgba(255,255,255,0.2);
    }

    html,body{margin:0;font-family:'Poppins',sans-serif;background:var(--background);color:var(--text-main);display:flex;flex-direction:column;align-items:center;min-height:100vh;overflow-x:hidden;}
    .topbar{position:fixed;top:20px;left:50%;transform:translateX(-50%);background:#000;color:var(--text-main);padding:20px 30px;display:flex;align-items:center;justify-content:space-between;border-radius:18px;width:90%;max-width:900px;box-shadow:0 0 20px rgba(255,255,255,0.4);z-index:100}
    .logo{height:55px;filter:drop-shadow(0 0 8px var(--accent))}
    .title{font-weight:700;font-size:2rem;letter-spacing:1.5px;text-transform:uppercase;color:var(--text-main);text-shadow:0 0 15px rgba(255,255,255,0.6);margin:0}
    .spacer{height:120px;}

    .card { background:var(--card-bg); border-radius:20px; padding:30px; width:90%; max-width:900px; box-shadow:var(--shadow); margin-bottom:60px; overflow:hidden; position:relative; }

    .stage { display:flex; width:200%; transition:transform .6s cubic-bezier(.22,.9,.3,1); }
    .panel { width:50%; box-sizing:border-box; padding:20px 30px; }

    form .row{display:flex;gap:12px;margin-bottom:12px}
    label{display:block;font-size:0.9rem;margin-bottom:6px;color:var(--muted)}
    input[type="text"],input[type="email"],select,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:#0f0f0f;color:var(--text-main)}
    textarea{min-height:90px;resize:vertical}
    .btn{display:inline-block;padding:12px 18px;border-radius:12px;background:var(--accent);color:#000;font-weight:600;border:none;cursor:pointer}
    .btn-secondary{background:#555;color:#fff;}
    .muted{color:var(--muted);font-size:0.9rem;margin-top:8px}

    .price{font-size:1.6rem;font-weight:500;margin:10px 0 25px 0;color:var(--text-main)}
    .paypal-area{max-width:360px;margin:0 auto}

    .confirm{padding:20px;text-align:center}

    /* Loader */
    .loader {
      width: 35px;
      aspect-ratio: 1;
      --_g: no-repeat radial-gradient(farthest-side,#000 94%,#0000);
      background:
        var(--_g) 0    0,
        var(--_g) 100% 0,
        var(--_g) 100% 100%,
        var(--_g) 0    100%;
      background-size: 40% 40%;
      animation: l38 .5s infinite; 
      margin: auto;
    }
    @keyframes l38 { 100% {background-position: 100% 0,100% 100%,0 100%,0 0} }
    .loader-overlay {
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 200;
      border-radius: 20px;
      display:none;
    }

    /* Récap aligné à gauche */
    #recap{margin-left:0;text-align:left;white-space:pre-wrap;}

    @media (max-width:900px){
      .stage{flex-direction:column;width:100%}
      .panel{width:100%}
    }
  </style>

  <script src="https://www.paypal.com/sdk/js?client-id=BAARVD2jx5IiVnvntDbXIr373cCT40elk40sjDGIB8MzbSwEYIDvUcA8IlghJCrfGjhCp37MbcEIB3CKto&currency=EUR&components=buttons"></script>
</head>
<body>
  <header class="topbar">
    <img src="GEEKSOFT.png" alt="GEEKSOFT" class="logo" />
    <div class="title">GEEKSOFT - DEVIS</div>
  </header>

  <div class="spacer"></div>

  <div class="card" id="card">
    <div class="loader-overlay" id="loader-overlay">
      <div class="loader"></div>
    </div>

    <div class="stage" id="stage">
      <!-- PANEL 1 : FORMULAIRE -->
      <div class="panel" id="panel-form">
        <h2>Paiement du devis</h2>
        <p class="muted">Remplissez vos informations et décrivez ce que le bot doit faire.</p>

        <form id="quote-form">
          <div class="row">
            <div style="flex:1">
              <label for="firstname">Prénom</label>
              <input id="firstname" name="firstname" type="text" required />
            </div>
            <div style="flex:1">
              <label for="lastname">Nom</label>
              <input id="lastname" name="lastname" type="text" required />
            </div>
          </div>

          <div class="row">
            <div style="flex:1">
              <label for="email">Email</label>
              <input id="email" name="email" type="email" required />
            </div>
            <div style="flex:1">
              <label for="botname">Nom du bot</label>
              <input id="botname" name="botname" type="text" placeholder="Ex : MonSuperBot" required />
            </div>
          </div>

          <div class="row">
            <div style="flex:1">
              <label for="members">Nombre de membres</label>
              <select id="members" name="members">
                <option value="0-100">0 - 100</option>
                <option value="101-500">101 - 500</option>
                <option value="501-2000">501 - 2000</option>
                <option value="2001+">2001+</option>
              </select>
            </div>
          </div>

          <label for="features">Fonctionnalités demandées</label>
          <textarea id="features" name="features" placeholder="Ex : commandes modération, XP, tickets..."></textarea>

          <div style="display:flex;gap:12px;margin-top:18px;align-items:center">
            <button type="submit" class="btn" id="send-quote">Envoyer mon devis</button>
            <div class="muted" id="status-note">Après envoi, tu seras redirigé vers le paiement.</div>
          </div>
        </form>
      </div>

      <!-- PANEL 2 : PAIEMENT -->
      <div class="panel" id="panel-pay" aria-hidden="true">
        <h2>Récapitulatif & Paiement</h2>
        <div id="recap"></div>
        <button class="btn btn-secondary" id="edit-info" style="margin-bottom:12px;">Modifier mes infos</button>

        <div class="price">Montant : <strong id="amount-display">0,50 €</strong></div>
        <div class="paypal-area" id="paypal-area"></div>
        <p class="muted">Paiement sécurisé via PayPal. Une fois le paiement effectué, vous recevrez le devis complet par e‑mail.</p>
      </div>
    </div>

    <!-- CONFIRMATION -->
    <div id="confirmation" style="display:none" class="confirm">
      <h2>Devis payé ✅</h2>
      <p>Merci — votre paiement a été reçu. Vous allez recevoir le devis complet par e‑mail dans quelques minutes.</p>
      <p class="muted">Si problème, contactez-nous.</p>
    </div>
  </div>

  <script>
    let CLIENT_QUOTE = null;
    const PRICE_EUR = "0.50";

    const stage = document.getElementById('stage');
    const form = document.getElementById('quote-form');
    const paypalArea = document.getElementById('paypal-area');
    const recap = document.getElementById('recap');
    const confirmation = document.getElementById('confirmation');
    const panelPay = document.getElementById('panel-pay');
    const loader = document.getElementById('loader-overlay');
    const editBtn = document.getElementById('edit-info');

    function showLoader(){ loader.style.display='flex'; }
    function hideLoader(){ loader.style.display='none'; }
    function showPaymentPanel(){ stage.style.transform = window.innerWidth > 900 ? 'translateX(-50%)' : 'translateX(0)'; panelPay.setAttribute('aria-hidden','false'); }
    function showConfirmation(){ document.getElementById('card').querySelector('.stage').style.display='none'; confirmation.style.display='block'; }

    async function saveQuoteServer(payload){
      const url='/api/quotes';
      try{
        const res = await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
        if(!res.ok)throw new Error('Erreur serveur');
        return await res.json();
      }catch(err){
        console.warn('Serveur absent ou erreur.',err);
        return {quote_id:'temp-'+Date.now(),secret_token:null};
      }
    }

    function mountPaypalButtons(quote_id){
      paypalArea.innerHTML='';
      paypal.Buttons({
        createOrder:function(data,actions){return actions.order.create({purchase_units:[{amount:{value:PRICE_EUR},custom_id:quote_id}]});},
        onApprove:function(data,actions){return actions.order.capture().then(details=>{confirmToServer(data.orderID,quote_id,details);});},
        onError:function(err){console.error('PayPal error',err); alert('Erreur lors du paiement PayPal.');}
      }).render('#paypal-area');
    }

    async function confirmToServer(orderID,quote_id,clientCaptureDetails){
      showLoader();
      const url='/api/confirm-payment';
      const payload={orderID,quote_id};
      try{
        const res=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
        if(!res.ok)throw new Error('Confirmation serveur échouée');
        const data=await res.json();
        hideLoader();
        if(data.verified){showConfirmation();} else {alert('Paiement reçu mais vérification serveur a échoué.');}
      }catch(err){hideLoader();console.error(err);alert('Erreur lors de la confirmation serveur.');}
    }

    form.addEventListener('submit',async function(e){
      e.preventDefault();
      showLoader();
      const formData=new FormData(form);
      const payload={
        firstname:formData.get('firstname'),
        lastname:formData.get('lastname'),
        email:formData.get('email'),
        botname:formData.get('botname'),
        members_range:formData.get('members'),
        features:formData.get('features'),
        amount:PRICE_EUR,
        created_at:new Date().toISOString()
      };
      const serverResp=await saveQuoteServer(payload);
      const quote_id=serverResp.quote_id||('temp-'+Date.now());
      CLIENT_QUOTE={...payload,quote_id};

      recap.innerHTML=
        `Nom du bot : ${payload.botname}\nPrénom/Nom : ${payload.firstname} ${payload.lastname}\nEmail : ${payload.email}\nMembres : ${payload.members_range}\nFonctionnalités : ${payload.features||'(non précisé)'}`;

      showPaymentPanel();
      mountPaypalButtons(quote_id);
      hideLoader();
    });

    editBtn.addEventListener('click',()=>{
      stage.style.transform='translateX(0)';
    });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Fichiers - GeekSoft</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/png" href="GEEKSOFT.png" />
  <style>
    :root {
      --black: #000;
      --white: #fff;
      --muted: #666;
      --glow: #ffffff;
      --gray-bg: #1e1e1e;
      --max-width: 2000px;
    }
    html, body {
      margin: 0;
      padding: 0;
      min-height: 100vh;
      font-family: 'Arial Black', Impact, sans-serif;
      background: var(--gray-bg);
      color: var(--white);
      box-sizing: border-box;
    }
    @keyframes slideDown {
      from { opacity: 0; transform: translateX(-50%) translateY(-100px); }
      to { opacity: 1; transform: translateX(-50%) translateY(0); }
    }
    .topbar {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--black);
      color: var(--white);
      padding: 20px 40px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 0 30px var(--glow), 0 8px 20px rgba(255, 255, 255, 0.2);
      border-radius: 26px;
      width: 90vw;
      max-width: var(--max-width);
      z-index: 1000;
      animation: slideDown 0.8s cubic-bezier(.44,1.3,.44,1) forwards;
    }
    .logo {
      height: 70px;
      width: auto;
      display: block;
    }
    .title {
      position: absolute;
      left: 48%;
      transform: translateX(-50%);
      font-weight: 900;
      font-size: 3.5rem;
      letter-spacing: 3px;
      text-transform: uppercase;
      color: var(--white);
      text-shadow: 0 0 15px var(--glow), 0 0 30px var(--glow);
    }
    main {
      margin-top: 120px;
      width: 98vw;
      max-width: var(--max-width);
      margin-left: auto;
      margin-right: auto;
      background: #242424;
      border-radius: 22px;
      box-shadow: 0 6px 30px #000a;
      padding: 2.5vw 2vw;
      font-size: 1rem;
      line-height: 1.4em;
      color: #47c5ff;
      min-height: 65vh;
      max-height: 78vh;
      overflow-y: auto;
      display: flex;
      gap: 2vw;
      flex-wrap: wrap;
      animation: fadeInUp 1s cubic-bezier(.44,1.3,.44,1) both;
    }
    #file-list {
      flex-basis: 220px;
      border-right: 2px solid #3a3a3a;
      padding-right: 10px;
    }
    #file-list ul {
      list-style: none;
      padding-left: 0;
      max-height: 100%;
      overflow-y: auto;
    }
    #file-list li {
      padding: 8px 6px;
      cursor: pointer;
      border-radius: 6px;
      transition: background 0.2s;
      user-select: none;
    }
    #file-list li:hover, #file-list li.selected {
      background: #47c5ff;
      color: #000;
      font-weight: bold;
    }
    #file-content {
      flex-grow: 1;
      background: #1b1b1b;
      border-radius: 12px;
      padding: 18px;
      overflow-x: auto;
      white-space: pre-wrap;
      font-family: monospace, monospace;
      color: #47c5ff;
      min-width: 320px;
      max-height: 68vh;
      box-shadow: inset 0 0 8px #000a;
    }
    a.back-link {
      display: inline-block;
      margin-top: 18px;
      color: #888;
      text-decoration: none;
      font-size: 16px;
      transition: color 0.2s;
    }
    a.back-link:hover {
      color: #47c5ff;
      text-decoration: underline;
    }
    button {
      background: #47c5ff;
      color: #fff;
      font-weight: bold;
      padding: 12px 30px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 1.2rem;
      box-shadow: 0 2px 8px #113d5e;
      margin-bottom: 12px;
      transition: background-color 0.3s ease;
    }
    button:hover {
      background: #0084ff;
    }
    @media (max-width: 900px) {
      .topbar {
        width: 100vw;
        border-radius: 16px;
        left: 0;
        transform: none;
        max-width: 100vw;
      }
      main {
        max-width: 99vw;
        width: 99vw;
        padding: 10px 4vw;
        flex-direction: column;
        min-height: 60vh;
        max-height: none;
      }
      #file-list {
        border-right: none;
        border-bottom: 2px solid #3a3a3a;
        padding-right: 0;
        padding-bottom: 10px;
        max-height: 195px;
      }
      #file-content {
        max-height: 40vh;
        min-width: 140px;
        padding: 10px;
        font-size: 95%;
      }
    }
  </style>
</head>
<body>
  <header class="topbar">
    <img src="GEEKSOFT.png" alt="GEEKSOFT" class="logo" />
    <div class="title">GEEKSOFT - FICHIERS</div>
  </header>
  <main>
    <section id="file-list" aria-label="Liste des fichiers">
      <button id="reload-files-btn">Recharger la liste des fichiers</button>
      <ul id="files-ul">
        <li>Chargement...</li>
      </ul>
    </section>
    <section id="file-content" aria-label="Contenu du fichier sélectionné">
      Sélectionnez un fichier pour en voir le contenu.
    </section>
  </main>
  <a href="panel.html" class="back-link">← Retour au panel (v1.1.6)</a>

  <script>
    let mdp = null;
    const filesUl = document.getElementById('files-ul');
    const fileContent = document.getElementById('file-content');
    const reloadBtn = document.getElementById('reload-files-btn');

    async function promptPassword() {
      let tries = 3;
      while (tries > 0) {
        const input = prompt("Entrez le mot de passe pour accéder à la liste des fichiers :");
        if (input === null) {
          filesUl.innerHTML = "<li>Accès annulé par l'utilisateur.</li>";
          reloadBtn.disabled = true;
          return false;
        }
        mdp = input.trim();
        if (mdp.length === 0) {
          alert("Le mot de passe ne peut pas être vide.");
          tries--;
          continue;
        }
        // Test rapide pour valider
        try {
          const res = await fetch(`https://devmra.pythonanywhere.com/readfiles?mdp=${encodeURIComponent(mdp)}`);
          if (res.ok) {
            return true;
          } else {
            alert("Mot de passe incorrect.");
            tries--;
          }
        } catch (e) {
          alert("Erreur de connexion. Réessayez.");
          tries--;
        }
      }
      filesUl.innerHTML = "<li>Trop d'essais échoués. Accès refusé.</li>";
      reloadBtn.disabled = true;
      return false;
    }

    async function loadFileList() {
      filesUl.innerHTML = "<li>Chargement...</li>";
      fileContent.textContent = "Sélectionnez un fichier pour en voir le contenu.";
      try {
        const res = await fetch(`https://devmra.pythonanywhere.com/readfiles?mdp=${encodeURIComponent(mdp)}`);
        if (!res.ok) throw new Error("Erreur récupération fichiers");
        const data = await res.json();
        if (!data.files || !Array.isArray(data.files)) throw new Error("Format de réponse invalide");
        if (data.files.length === 0) {
          filesUl.innerHTML = "<li>Aucun fichier trouvé.</li>";
          return;
        }
        filesUl.innerHTML = "";
        data.files.forEach((f) => {
          const li = document.createElement("li");
          li.textContent = f;
          li.tabIndex = 0;
          li.onclick = () => selectFile(f, li);
          li.onkeydown = (e) => {
            if(e.key === "Enter" || e.key === " ") {
              e.preventDefault();
              selectFile(f, li);
            }
          };
          filesUl.appendChild(li);
        });
      } catch(e) {
        filesUl.innerHTML = `<li>❌ ${e.message}</li>`;
      }
    }

    async function selectFile(filename, liElem) {
      Array.from(filesUl.children).forEach(li => li.classList.remove("selected"));
      liElem.classList.add("selected");
      fileContent.textContent = "Chargement du fichier...";
      try {
        const res = await fetch(`https://devmra.pythonanywhere.com/readfile?filename=${encodeURIComponent(filename)}&mdp=${encodeURIComponent(mdp)}`);
        if (!res.ok) throw new Error("Erreur lecture du fichier");
        const text = await res.text();
        fileContent.textContent = text || "[Fichier vide]";
      } catch(e) {
        fileContent.textContent = `❌ ${e.message}`;
      }
    }

    reloadBtn.addEventListener("click", () => {
      if(mdp) loadFileList();
    });

    (async () => {
      const access = await promptPassword();
      if (access) {
        loadFileList();
      }
    })();
  </script>
</body>
</html>

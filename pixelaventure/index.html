<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Pixel RPG - L'Aventure des 20 Jours</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        :root {
            --bg-color: #202028;
            --card-bg: #2d2d38;
            --accent: #e6b333; /* Or */
            --danger: #e63333; /* Rouge */
            --success: #33e666; /* Vert */
            --rare: #33a6e6; /* Bleu */
            --leg: #e633e6; /* Violet */
            --ultra: #e68a33; /* Orange */
        }

        body {
            background-color: var(--bg-color);
            color: #fff;
            font-family: 'Press Start 2P', cursive;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            line-height: 1.5;
            overflow-x: hidden;
        }

        /* --- UI Principale --- */
        #game-container {
            width: 100%;
            max-width: 900px; /* Plus large */
            position: relative;
        }

        h1 {
            text-align: center;
            color: var(--accent);
            text-shadow: 4px 4px 0 #000;
            margin-bottom: 20px;
            font-size: 28px;
        }

        /* --- MENU PRINCIPAL (NOUVEAU) --- */
        #main-menu {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(32, 32, 40, 0.95);
            z-index: 100;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border: 4px solid #fff;
            box-shadow: 0 0 50px #000;
        }

        .difficulty-btn {
            width: 250px;
            margin: 15px;
            padding: 20px;
            font-size: 14px;
            cursor: pointer;
            border: 4px solid #fff;
            background: #2d2d38;
            color: white;
            font-family: 'Press Start 2P', cursive;
            transition: 0.2s;
        }
        .difficulty-btn:hover { transform: scale(1.05); }
        .diff-easy:hover { background: var(--success); border-color: #fff; color: #000; }
        .diff-normal:hover { background: var(--rare); border-color: #fff; color: #000; }
        .diff-hard:hover { background: var(--danger); border-color: #fff; }

        /* --- Panneau Stats Joueur --- */
        .stats-panel {
            background: #000;
            border: 4px solid #fff;
            padding: 15px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
            box-shadow: 8px 8px 0 rgba(0,0,0,0.5);
        }

        .stat-box { text-align: center; }
        .stat-label { font-size: 10px; color: #aaa; margin-bottom: 5px; }
        .stat-value { font-size: 14px; color: #fff; }
        .stat-value.gold { color: var(--accent); }
        .stat-value.hp { color: var(--danger); }

        /* --- Zone de Log (AGRANDIE) --- */
        #log-area {
            background: rgba(0,0,0,0.8);
            border: 2px solid #555;
            height: 400px; /* Agrandissement significatif */
            overflow-y: auto;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 15px;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column-reverse; 
            box-shadow: inset 0 0 20px #000;
        }

        .log-entry { margin-bottom: 6px; border-bottom: 1px solid #333; padding-bottom: 4px; }
        .log-combat { color: #ff8888; }
        .log-loot { color: #88ff88; }
        .log-event { color: #88ffff; }
        .log-day { color: var(--accent); font-weight: bold; text-align: center; margin: 15px 0; border-top: 1px dashed #555; padding-top:10px; font-size: 18px;}

        /* --- Actions / Boutons --- */
        #action-area {
            text-align: center;
            min-height: 80px;
        }

        .pixel-btn {
            background: var(--card-bg);
            border: 4px solid #fff;
            color: #fff;
            padding: 15px 30px;
            font-family: 'Press Start 2P', cursive;
            font-size: 12px;
            cursor: pointer;
            margin: 10px;
            transition: transform 0.1s, background 0.2s;
            box-shadow: 6px 6px 0 #000;
        }

        .pixel-btn:hover:not(:disabled) {
            transform: translate(-2px, -2px);
            background: #3d3d4d;
            box-shadow: 8px 8px 0 #000;
        }
        .pixel-btn:active:not(:disabled) { transform: translate(2px, 2px); box-shadow: 2px 2px 0 #000; }
        .pixel-btn:disabled { opacity: 0.5; cursor: not-allowed; border-color: #555; color: #aaa; }

        /* --- Marchand / Cartes --- */
        #merchant-area {
            display: none;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }

        .card {
            background: var(--card-bg);
            border: 4px solid #fff;
            width: 200px;
            padding: 15px;
            text-align: center;
            position: relative;
            cursor: pointer;
            transition: transform 0.3s;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .card:hover { transform: translateY(-10px) scale(1.02); z-index: 10; }
        
        .card.common { border-color: #fff; }
        .card.rare { border-color: var(--rare); box-shadow: 0 0 10px var(--rare); }
        .card.legendary { border-color: var(--leg); box-shadow: 0 0 15px var(--leg); animation: pulse-leg 2s infinite; }
        .card.ultra { border-color: var(--ultra); box-shadow: 0 0 20px var(--ultra); animation: pulse-ultra 1.5s infinite; }

        @keyframes pulse-leg { 0% { box-shadow: 0 0 10px var(--leg); } 50% { box-shadow: 0 0 25px var(--leg); } 100% { box-shadow: 0 0 10px var(--leg); } }
        @keyframes pulse-ultra { 0% { box-shadow: 0 0 15px var(--ultra); border-color: #fff;} 50% { box-shadow: 0 0 30px var(--ultra); border-color: var(--ultra);} 100% { box-shadow: 0 0 15px var(--ultra); border-color: #fff;} }

        .card-title { font-size: 10px; margin-bottom: 10px; min-height: 24px; display: flex; align-items: center; justify-content: center;}
        .card-stats { font-size: 8px; color: #aaa; text-align: left; margin-bottom: 15px; }
        .card-price { font-size: 10px; color: var(--accent); margin-top: auto; padding-top: 10px; border-top: 2px dashed #555; }
        .card-icon { font-size: 30px; margin-bottom: 10px; }
        .capa-tag { background: #444; color: #fff; padding: 2px 4px; font-size: 7px; border-radius: 4px; display: inline-block; margin-top: 5px; }

        /* Barre de vie Boss */
        #boss-bar-container {
            width: 100%;
            height: 24px;
            background: #333;
            border: 4px solid #fff;
            margin-top: 10px;
            display: none;
            position: relative;
            box-shadow: 4px 4px 0 #000;
        }
        #boss-bar-fill { height: 100%; background: var(--danger); width: 100%; transition: width 0.2s; }
        #boss-name { position: absolute; top: -30px; left: 0; width: 100%; text-align: center; font-size: 12px; color: var(--danger); text-shadow: 1px 1px 0 #000; }

    </style>
</head>
<body>

    <div id="game-container">
        <!-- MENU PRINCIPAL -->
        <div id="main-menu">
            <h1 style="font-size: 40px; margin-bottom: 50px;">PIXEL QUEST</h1>
            <p style="margin-bottom: 30px; color: #aaa;">Choisissez votre destin</p>
            <button class="difficulty-btn diff-easy" onclick="startGame('easy')">FACILE<br><span style="font-size:8px; color:#aaa">PV+ Or+ Ennemis Faibles</span></button>
            <button class="difficulty-btn diff-normal" onclick="startGame('normal')">NORMAL<br><span style="font-size:8px; color:#aaa">Exp√©rience Classique</span></button>
            <button class="difficulty-btn diff-hard" onclick="startGame('hard')">DIFFICILE<br><span style="font-size:8px; color:#aaa">PV- Or- Ennemis Brutaux</span></button>
        </div>

        <h1>PIXEL QUEST</h1>

        <div class="stats-panel">
            <div class="stat-box">
                <div class="stat-label">JOUR</div>
                <div class="stat-value" id="ui-day">1</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">PV</div>
                <div class="stat-value hp" id="ui-hp">100</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">OR</div>
                <div class="stat-value gold" id="ui-gold">50</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">ATT</div>
                <div class="stat-value" id="ui-att">8</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">DEF</div>
                <div class="stat-value" id="ui-def">1.8</div>
            </div>
        </div>

        <div id="boss-bar-container">
            <div id="boss-name">BOSS</div>
            <div id="boss-bar-fill"></div>
        </div>

        <div id="log-area">
            <!-- Logs ici -->
        </div>

        <div id="action-area">
            <button id="btn-next" class="pixel-btn" onclick="nextPhase()">Lancer le Jour 1</button>
        </div>

        <div id="merchant-area">
            <!-- Les cartes seront inject√©es ici par JS -->
        </div>
    </div>

<script>
// ======================
// CONFIGURATION & DATA
// ======================

function randint(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }
function choice(array) { return array[Math.floor(Math.random() * array.length)]; }

let gameState = {
    phase: 'start',
    day: 1,
    gameOver: false,
    difficulty: 'normal',
    enemyMultiplier: 1.0
};

// Joueur (initialis√© au start)
let joueur = {};
const DEF_MIN = 0.3;

// Donn√©es de base
const baseEnnemis = {
    "voleur": {nom: "Voleur", pv: 60, att: 6, def: 2, or: 10},
    "guerrier": {nom: "Guerrier", pv: 100, att: 10, def: 1.5, or: 20},
    "champion": {nom: "Champion", pv: 180, att: 16, def: 1, or: 30},
    "boss10": {nom: "Seigneur de fer", pv: 300, att: 22, def: 1.2, or: 40},
    "boss20": {nom: "Roi du N√©ant", pv: 500, att: 30, def: 1.1, or: 50}
};

// Objets
let objets_communs = [
    {nom: "√âp√©e rouill√©e", att: 3, type: "common", icon: "üó°Ô∏è"},
    {nom: "Casque simple", pv: 10, type: "common", icon: "ü™ñ"},
    {nom: "Anneau us√©", def: -0.1, type: "common", icon: "üíç"},
    {nom: "Lance", att: 4, type: "common", icon: "üî±"},
    {nom: "B√¢ton magique", att: 2, regen: 1, type: "common", icon: "ü™Ñ"}
];

let objets_rares = [
    {nom: "√âp√©e fine", att: 6, type: "rare", icon: "‚öîÔ∏è"},
    {nom: "Armure renforc√©e", def: -0.3, type: "rare", icon: "üõ°Ô∏è"},
    {nom: "Amulette vitale", pv: 30, type: "rare", icon: "üßø"},
    {nom: "Anneau de pouvoir", pv: 15, att: 5, regen: 3, type: "rare", icon: "üíç"},
    {nom: "Colt 1911", att: 10, type: "rare", icon: "üî´"}
];

let objets_legendaires = [
    {nom: "Lame mythique", att: 20, pv: 30, type: "legendary", icon: "üî•"},
    {nom: "Armure enchant√©e", pv: 60, def: -0.3, regen: 5, type: "legendary", icon: "‚ú®"},
    {nom: "Coeur du h√©ros", pv: 50, capa: "vol_de_vie", type: "legendary", icon: "‚ù§Ô∏è"},
    {nom: "Carapace absolue", pv: 50, capa: "reduc_degats", type: "legendary", icon: "üê¢"},
    {nom: "Lames fr√©n√©tiques", att: 15, capa: "multi_attaque", type: "legendary", icon: "üå™Ô∏è"}
];

let objets_ultra = [
    {nom: "Bouclier invincible", pv: 50, capa: "invincible_3tour", type: "ultra", icon: "üõ°Ô∏è‚ú®"},
    {nom: "Gantelet puissance", att: 10, capa: "crit_25", type: "ultra", icon: "ü•ä"},
    {nom: "Cape du destin", capa: "esquive_total", type: "ultra", icon: "üëª"}
];

// Copies pour reset
let pool_leg = [...objets_legendaires];
let pool_ultra = [...objets_ultra];

// ======================
// UI Elements
// ======================
const uiDay = document.getElementById('ui-day');
const uiHp = document.getElementById('ui-hp');
const uiGold = document.getElementById('ui-gold');
const uiAtt = document.getElementById('ui-att');
const uiDef = document.getElementById('ui-def');
const logArea = document.getElementById('log-area');
const btnNext = document.getElementById('btn-next');
const merchantArea = document.getElementById('merchant-area');
const bossBarContainer = document.getElementById('boss-bar-container');
const bossBarFill = document.getElementById('boss-bar-fill');
const bossName = document.getElementById('boss-name');
const mainMenu = document.getElementById('main-menu');

// ======================
// GESTION DU JEU
// ======================

function startGame(diff) {
    gameState.difficulty = diff;
    gameState.day = 1;
    gameState.gameOver = false;
    
    // Reset lists
    pool_leg = [...objets_legendaires];
    pool_ultra = [...objets_ultra];
    
    logArea.innerHTML = ''; // Clear logs

    // Configuration selon difficult√©
    if (diff === 'easy') {
        joueur = { pv: 150, att: 8, def: 1.8, or: 80, regen: 30, capas: [] };
        gameState.enemyMultiplier = 0.8; // Ennemis plus faibles
        log("Difficult√© : FACILE. Vous commencez riche et fort.", "day");
    } else if (diff === 'normal') {
        joueur = { pv: 100, att: 8, def: 1.8, or: 50, regen: 20, capas: [] };
        gameState.enemyMultiplier = 1.0;
        log("Difficult√© : NORMALE. Bonne chance.", "day");
    } else if (diff === 'hard') {
        joueur = { pv: 80, att: 8, def: 1.8, or: 20, regen: 10, capas: [] };
        gameState.enemyMultiplier = 1.2; // Ennemis plus forts
        log("Difficult√© : DIFFICILE. La mort vous attend.", "day");
    }

    mainMenu.style.display = 'none';
    updateUI();
    btnNext.style.display = 'inline-block';
    btnNext.innerText = "Lancer Jour 1";
    btnNext.onclick = nextPhase;
}

function updateUI() {
    uiDay.textContent = gameState.day;
    uiHp.textContent = Math.floor(joueur.pv);
    uiGold.textContent = joueur.or;
    uiAtt.textContent = joueur.att;
    uiDef.textContent = Math.round(joueur.def * 100) / 100;
}

function log(msg, type = "normal") {
    const div = document.createElement('div');
    div.classList.add('log-entry');
    if (type) div.classList.add('log-'+type);
    div.innerHTML = msg;
    logArea.prepend(div);
}

function toggleButton(text, action, enabled = true) {
    btnNext.innerText = text;
    btnNext.onclick = action;
    btnNext.disabled = !enabled;
    btnNext.style.display = enabled ? 'inline-block' : 'none';
}

// ======================
// LOGIQUE DE JEU
// ======================

function getEnemy(key) {
    let base = baseEnnemis[key];
    let mult = gameState.enemyMultiplier;
    return {
        nom: base.nom,
        pv: Math.floor(base.pv * mult),
        att: Math.floor(base.att * mult),
        def: base.def, // La def ennemie ne change pas (sinon √ßa casse le calcul de d√©g√¢ts)
        or: base.or
    };
}

function appliquerObjet(obj) {
    log(`Objet obtenu : <strong>${obj.nom}</strong>`, "loot");
    for (const [key, val] of Object.entries(obj)) {
        if (["nom", "type", "icon"].includes(key)) continue;
        if (key === "capa") {
            if (!joueur.capas.includes(val)) {
                joueur.capas.push(val);
                log(`> Comp√©tence apprise: ${val}`);
            }
        } else {
            joueur[key] += val;
        }
    }
    joueur.def = Math.max(DEF_MIN, joueur.def);

    // Retrait des listes uniques (on travaille sur les copies pool_)
    if (obj.type === "legendary") pool_leg = pool_leg.filter(o => o.nom !== obj.nom);
    if (obj.type === "ultra") pool_ultra = pool_ultra.filter(o => o.nom !== obj.nom);
    
    updateUI();
}

function lootDuJour() {
    const probs = [
        [objets_communs, 100],
        [objets_communs, 50],
        [objets_rares, 50],
        [pool_leg, 2],
        [pool_ultra, 1]
    ];
    let found = false;
    for (let p of probs) {
        if (p[0].length > 0 && randint(1, 100) <= p[1]) {
            let obj = choice(p[0]);
            appliquerObjet(obj);
            found = true;
        }
    }
    if (!found) log("Rien trouv√© ce matin...", "loot");
}

async function combat(ennemi) {
    log(`COMBAT : ${ennemi.nom} (PV: ${ennemi.pv}, ATT: ${ennemi.att})`, "combat");
    let maxPvEnnemi = ennemi.pv;
    let invincibleTour = joueur.capas.includes("invincible_3tour") ? 3 : 0;
    
    let isBoss = ennemi.nom.includes("Seigneur") || ennemi.nom.includes("Roi");
    if (isBoss) {
        bossBarContainer.style.display = 'block';
        bossName.innerText = ennemi.nom;
        bossBarFill.style.width = '100%';
    }

    return new Promise((resolve) => {
        let combatLoop = setInterval(() => {
            // -- JOUEUR --
            let attaques = 1;
            if (joueur.capas.includes("multi_attaque")) {
                while(randint(1, 2) === 1) attaques++;
            }
            let totalDegats = 0;
            for (let i = 0; i < attaques; i++) {
                let degats = joueur.att * ennemi.def;
                if (joueur.capas.includes("crit_25") && randint(1, 100) <= 25) {
                    degats *= 5;
                    log("CRITIQUE !", "combat");
                }
                ennemi.pv -= degats;
                totalDegats += degats;
                if (joueur.capas.includes("vol_de_vie")) joueur.pv += degats * 0.4;
                if (ennemi.pv <= 0) break;
            }
            log(`Vous infligez ${Math.floor(totalDegats)} d√©g√¢ts.`, "combat");
            
            if (isBoss) bossBarFill.style.width = Math.max(0, (ennemi.pv / maxPvEnnemi) * 100) + '%';

            if (ennemi.pv <= 0) {
                clearInterval(combatLoop);
                if (isBoss) bossBarContainer.style.display = 'none';
                joueur.or += ennemi.or;
                joueur.pv += joueur.regen;
                log(`VICTOIRE ! +${ennemi.or} or. +${joueur.regen} PV regen.`, "success");
                updateUI();
                resolve(true);
                return;
            }

            // -- ENNEMI --
            let degatsSubis = ennemi.att * joueur.def;
            if (joueur.capas.includes("reduc_degats")) degatsSubis /= 2;
            if (gameState.difficulty === 'hard') degatsSubis *= 1.1; // Bonus d√©g√¢ts hard mode cach√©

            if (invincibleTour > 0) {
                degatsSubis = 0;
                invincibleTour--;
                log("Invuln√©rable !", "combat");
            }
            
            joueur.pv -= degatsSubis;
            log(`${ennemi.nom} attaque ! -${Math.floor(degatsSubis)} PV.`, "combat");
            updateUI();

            if (joueur.pv <= 0) {
                clearInterval(combatLoop);
                log("VOUS √äTES MORT...", "combat");
                resolve(false);
                return;
            }
        }, 800);
    });
}

// Events
const eventsList = [
    { type: 'combat', id: 'voleur' },
    { type: 'combat', id: 'voleur' },
    { type: 'combat', id: 'guerrier' },
    { type: 'combat', id: 'guerrier' },
    { type: 'gain', val: 30, text: "Tu trouves une bourse : +30 or" },
    { type: 'gain', val: 45, text: "Gros tr√©sor ! +45 or" },
    { type: 'heal', val: 10, text: "Rencontre paisible, +10 PV" },
    { type: 'pari_risk' },
    { type: 'pari_win' }
];

async function lancerEvent(day) {
    let pool = [...eventsList];
    if (day >= 5) pool.push({ type: 'combat', id: 'champion' });
    let evt = choice(pool);

    if (evt.type === 'combat') {
        return await combat(getEnemy(evt.id));
    } else if (evt.type === 'gain') {
        log(evt.text, "event");
        joueur.or += evt.val;
    } else if (evt.type === 'heal') {
        log(evt.text, "event");
        joueur.pv += evt.val;
    } else if (evt.type === 'pari_risk') {
        if (randint(1, 2) === 1) {
            joueur.or += 40;
            log("Pari risqu√© gagn√© ! +40 or", "event");
        } else {
            joueur.or -= 20;
            log("Pari risqu√© perdu... -20 or", "event");
        }
    } else if (evt.type === 'pari_win') {
        joueur.or += 40;
        log("Pari chanceux ! +40 or", "event");
    }
    updateUI();
    return true;
}

// Marchand
function generateCard(obj) {
    const card = document.createElement('div');
    card.className = `card ${obj.type}`;
    card.onclick = () => acheterObjet(obj, card);

    let statsHtml = '';
    for (const [key, val] of Object.entries(obj)) {
        if (["nom", "type", "icon", "capa"].includes(key)) continue;
        statsHtml += `<div>${key.toUpperCase()}: ${val > 0 ? '+' : ''}${val}</div>`;
    }
    let capaHtml = obj.capa ? `<div class="capa-tag">${obj.capa}</div>` : '';

    card.innerHTML = `
        <div class="card-icon">${obj.icon}</div>
        <div class="card-title">${obj.nom}</div>
        <div class="card-stats">${statsHtml}${capaHtml}</div>
        <div class="card-price">20 OR</div>
    `;
    return card;
}

function ouvrirMarchand() {
    log("Le marchand est l√†.", "event");
    merchantArea.innerHTML = '';
    merchantArea.style.display = 'flex';
    toggleButton("Quitter le marchand", fermerMarchand);

    const probs = [
        [objets_communs, 100],
        [objets_communs, 100],
        [objets_rares, 40],
        [pool_leg, 5],
        [pool_ultra, 2]
    ];
    
    for (let p of probs) {
        if (p[0].length > 0 && randint(1, 100) <= p[1]) {
            let item = choice(p[0]);
            merchantArea.appendChild(generateCard(item));
        }
    }
}

function acheterObjet(obj, card) {
    if (joueur.or >= 20) {
        joueur.or -= 20;
        appliquerObjet(obj);
        card.style.transform = "scale(0)";
        setTimeout(() => card.remove(), 300);
    } else {
        log("Pas assez d'or !", "event");
        card.style.borderColor = "red";
        setTimeout(() => card.style.borderColor = "", 500);
    }
}

function fermerMarchand() {
    merchantArea.style.display = 'none';
    finDuJour();
}

// ======================
// CONTROLEUR
// ======================
async function nextPhase() {
    toggleButton("...", null, false);
    
    if (gameState.gameOver) {
        mainMenu.style.display = 'flex'; // Retour menu
        return;
    }

    log(`===== JOUR ${gameState.day} =====`, "day");
    
    lootDuJour();
    if (joueur.pv <= 0) return gameOver();

    let vivant = true;
    if (gameState.day === 10) vivant = await combat(getEnemy("boss10"));
    else if (gameState.day === 20) vivant = await combat(getEnemy("boss20"));
    else vivant = await lancerEvent(gameState.day);

    if (!vivant) return gameOver();

    if (gameState.day === 20 && vivant) victory();
    else ouvrirMarchand();
}

function finDuJour() {
    gameState.day++;
    updateUI();
    toggleButton(`Lancer Jour ${gameState.day}`, nextPhase);
}

function gameOver() {
    log("‚ò†Ô∏è FIN DE PARTIE ‚ò†Ô∏è", "combat");
    gameState.gameOver = true;
    toggleButton("Retour Menu", () => {
        mainMenu.style.display = 'flex';
        logArea.innerHTML = '';
    }, true);
}

function victory() {
    log("üèÜ L√âGENDE ! 20 JOURS SURV√âCUS ! üèÜ", "success");
    gameState.gameOver = true;
    toggleButton("Retour Menu", () => {
        mainMenu.style.display = 'flex';
        logArea.innerHTML = '';
    }, true);
}
</script>
</body>
</html>

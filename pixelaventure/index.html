<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Pixel RPG - L'Aventure des 20 Jours</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        :root {
            --bg-color: #202028;
            --card-bg: #2d2d38;
            --accent: #e6b333; /* Or */
            --danger: #e63333; /* Rouge */
            --success: #33e666; /* Vert */
            --rare: #33a6e6; /* Bleu */
            --leg: #e633e6; /* Violet */
            --ultra: #e68a33; /* Orange */
        }

        body {
            background-color: var(--bg-color);
            color: #fff;
            font-family: 'Press Start 2P', cursive;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            line-height: 1.5;
            overflow-x: hidden;
        }

        /* --- UI Principale --- */
        #game-container {
            width: 100%;
            max-width: 800px;
            position: relative;
        }

        h1 {
            text-align: center;
            color: var(--accent);
            text-shadow: 4px 4px 0 #000;
            margin-bottom: 30px;
            font-size: 24px;
        }

        /* --- Panneau Stats Joueur --- */
        .stats-panel {
            background: #000;
            border: 4px solid #fff;
            padding: 15px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
            box-shadow: 8px 8px 0 rgba(0,0,0,0.5);
        }

        .stat-box {
            text-align: center;
        }
        .stat-label { font-size: 10px; color: #aaa; margin-bottom: 5px; }
        .stat-value { font-size: 14px; color: #fff; }
        .stat-value.gold { color: var(--accent); }
        .stat-value.hp { color: var(--danger); }

        /* --- Zone de Log (Console) --- */
        #log-area {
            background: rgba(0,0,0,0.8);
            border: 2px solid #555;
            height: 200px;
            overflow-y: auto;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column-reverse; /* Nouveaux messages en bas mais scrolables */
        }

        .log-entry { margin-bottom: 5px; border-bottom: 1px solid #333; padding-bottom: 2px; }
        .log-combat { color: #ff8888; }
        .log-loot { color: #88ff88; }
        .log-event { color: #88ffff; }
        .log-day { color: var(--accent); font-weight: bold; text-align: center; margin: 10px 0; border-top: 1px dashed #555; padding-top:10px;}

        /* --- Actions / Boutons --- */
        #action-area {
            text-align: center;
            min-height: 100px;
        }

        .pixel-btn {
            background: var(--card-bg);
            border: 4px solid #fff;
            color: #fff;
            padding: 15px 30px;
            font-family: 'Press Start 2P', cursive;
            font-size: 12px;
            cursor: pointer;
            margin: 10px;
            transition: transform 0.1s, background 0.2s;
            box-shadow: 6px 6px 0 #000;
        }

        .pixel-btn:hover:not(:disabled) {
            transform: translate(-2px, -2px);
            background: #3d3d4d;
            box-shadow: 8px 8px 0 #000;
        }

        .pixel-btn:active:not(:disabled) {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0 #000;
        }

        .pixel-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            border-color: #555;
            color: #aaa;
        }

        /* --- Marchand / Cartes --- */
        #merchant-area {
            display: none; /* Cach√© par d√©faut */
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }

        .card {
            background: var(--card-bg);
            border: 4px solid #fff;
            width: 200px;
            padding: 15px;
            text-align: center;
            position: relative;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        /* Animations des cartes */
        .card:hover {
            transform: translateY(-10px) scale(1.02);
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
            z-index: 10;
        }

        /* Raret√©s */
        .card.common { border-color: #fff; }
        .card.rare { border-color: var(--rare); box-shadow: 0 0 10px var(--rare); }
        .card.legendary { border-color: var(--leg); box-shadow: 0 0 15px var(--leg); animation: pulse-leg 2s infinite; }
        .card.ultra { border-color: var(--ultra); box-shadow: 0 0 20px var(--ultra); animation: pulse-ultra 1.5s infinite; }

        @keyframes pulse-leg { 0% { box-shadow: 0 0 10px var(--leg); } 50% { box-shadow: 0 0 25px var(--leg); } 100% { box-shadow: 0 0 10px var(--leg); } }
        @keyframes pulse-ultra { 0% { box-shadow: 0 0 15px var(--ultra); border-color: #fff;} 50% { box-shadow: 0 0 30px var(--ultra); border-color: var(--ultra);} 100% { box-shadow: 0 0 15px var(--ultra); border-color: #fff;} }

        .card-title { font-size: 10px; margin-bottom: 10px; min-height: 24px; display: flex; align-items: center; justify-content: center;}
        .card-stats { font-size: 8px; color: #aaa; text-align: left; margin-bottom: 15px; }
        .card-stats div { margin: 2px 0; }
        .card-price { font-size: 10px; color: var(--accent); margin-top: auto; padding-top: 10px; border-top: 2px dashed #555; }
        
        .card-icon {
            font-size: 30px;
            margin-bottom: 10px;
        }

        /* Capas sp√©ciales */
        .capa-tag {
            background: #444;
            color: #fff;
            padding: 2px 4px;
            font-size: 7px;
            border-radius: 4px;
            display: inline-block;
            margin-top: 5px;
        }

        /* Barre de vie Boss */
        #boss-bar-container {
            width: 100%;
            height: 20px;
            background: #333;
            border: 2px solid #fff;
            margin-top: 10px;
            display: none;
            position: relative;
        }
        #boss-bar-fill {
            height: 100%;
            background: var(--danger);
            width: 100%;
            transition: width 0.2s;
        }
        #boss-name {
            position: absolute;
            top: -25px;
            left: 0;
            width: 100%;
            text-align: center;
            font-size: 10px;
            color: var(--danger);
        }

    </style>
</head>
<body>

    <div id="game-container">
        <h1>PIXEL QUEST</h1>

        <div class="stats-panel">
            <div class="stat-box">
                <div class="stat-label">JOUR</div>
                <div class="stat-value" id="ui-day">1</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">PV</div>
                <div class="stat-value hp" id="ui-hp">100</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">OR</div>
                <div class="stat-value gold" id="ui-gold">50</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">ATT</div>
                <div class="stat-value" id="ui-att">8</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">DEF</div>
                <div class="stat-value" id="ui-def">1.8</div>
            </div>
        </div>

        <div id="boss-bar-container">
            <div id="boss-name">BOSS</div>
            <div id="boss-bar-fill"></div>
        </div>

        <div id="log-area">
            <div class="log-entry">Bienvenue, aventurier. Survivez 20 jours.</div>
        </div>

        <div id="action-area">
            <button id="btn-next" class="pixel-btn" onclick="nextPhase()">Lancer le Jour 1</button>
        </div>

        <div id="merchant-area">
            <!-- Les cartes seront inject√©es ici par JS -->
        </div>
    </div>

<script>
// ======================
// CONFIGURATION & DATA
// ======================

// Helper pour les nombres al√©atoires
function randint(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
}
function choice(array) {
    return array[Math.floor(Math.random() * array.length)];
}

// √âtat du jeu
let gameState = {
    phase: 'start', // start, loot, event, combat, merchant, end
    day: 1,
    gameOver: false
};

// Joueur
let joueur = {
    pv: 100,
    att: 8,
    def: 1.8,
    or: 50,
    regen: 20,
    capas: []
};

const DEF_MIN = 0.3;

// Ennemis
const ennemisData = {
    "voleur": {nom: "Voleur", pv: 60, att: 6, def: 2, or: 10},
    "guerrier": {nom: "Guerrier", pv: 100, att: 10, def: 1.5, or: 20},
    "champion": {nom: "Champion", pv: 180, att: 16, def: 1, or: 30},
    "boss10": {nom: "Seigneur de fer", pv: 300, att: 22, def: 1.2, or: 40},
    "boss20": {nom: "Roi du N√©ant", pv: 500, att: 30, def: 1.1, or: 50}
};

// Objets
// Note: On ajoute des 'type' pour le CSS (common, rare, legendary, ultra)
// et des icones unicode pour le style
let objets_communs = [
    {nom: "√âp√©e rouill√©e", att: 3, type: "common", icon: "üó°Ô∏è"},
    {nom: "Casque simple", pv: 10, type: "common", icon: "ü™ñ"},
    {nom: "Anneau us√©", def: -0.1, type: "common", icon: "üíç"},
    {nom: "Lance", att: 4, type: "common", icon: "üî±"},
    {nom: "B√¢ton magique", att: 2, regen: 1, type: "common", icon: "ü™Ñ"}
];

let objets_rares = [
    {nom: "√âp√©e fine", att: 6, type: "rare", icon: "‚öîÔ∏è"},
    {nom: "Armure renforc√©e", def: -0.3, type: "rare", icon: "üõ°Ô∏è"},
    {nom: "Amulette vitale", pv: 30, type: "rare", icon: "üßø"},
    {nom: "Anneau de pouvoir", pv: 15, att: 5, regen: 3, type: "rare", icon: "üíç"},
    {nom: "Colt 1911", att: 10, type: "rare", icon: "üî´"}
];

let objets_legendaires = [
    {nom: "Lame mythique", att: 20, pv: 30, type: "legendary", icon: "üî•"},
    {nom: "Armure enchant√©e", pv: 60, def: -0.3, regen: 5, type: "legendary", icon: "‚ú®"},
    {nom: "Coeur du h√©ros", pv: 50, capa: "vol_de_vie", type: "legendary", icon: "‚ù§Ô∏è"},
    {nom: "Carapace absolue", pv: 50, capa: "reduc_degats", type: "legendary", icon: "üê¢"},
    {nom: "Lames fr√©n√©tiques", att: 15, capa: "multi_attaque", type: "legendary", icon: "üå™Ô∏è"}
];

let objets_ultra = [
    {nom: "Bouclier invincible", pv: 50, capa: "invincible_3tour", type: "ultra", icon: "üõ°Ô∏è‚ú®"},
    {nom: "Gantelet puissance", att: 10, capa: "crit_25", type: "ultra", icon: "ü•ä"},
    {nom: "Cape du destin", capa: "esquive_total", type: "ultra", icon: "üëª"}
];

// ======================
// MOTEUR GRAPHIQUE (UI)
// ======================

const uiDay = document.getElementById('ui-day');
const uiHp = document.getElementById('ui-hp');
const uiGold = document.getElementById('ui-gold');
const uiAtt = document.getElementById('ui-att');
const uiDef = document.getElementById('ui-def');
const logArea = document.getElementById('log-area');
const btnNext = document.getElementById('btn-next');
const merchantArea = document.getElementById('merchant-area');
const bossBarContainer = document.getElementById('boss-bar-container');
const bossBarFill = document.getElementById('boss-bar-fill');
const bossName = document.getElementById('boss-name');

function updateUI() {
    uiDay.textContent = gameState.day;
    uiHp.textContent = Math.floor(joueur.pv);
    uiGold.textContent = joueur.or;
    uiAtt.textContent = joueur.att;
    // Arrondi def √† 2 d√©cimales
    uiDef.textContent = Math.round(joueur.def * 100) / 100;
}

function log(msg, type = "normal") {
    const div = document.createElement('div');
    div.classList.add('log-entry');
    if (type === "combat") div.classList.add('log-combat');
    if (type === "loot") div.classList.add('log-loot');
    if (type === "event") div.classList.add('log-event');
    if (type === "day") div.classList.add('log-day');
    
    div.innerHTML = msg; // Permet d'injecter du HTML si besoin
    logArea.prepend(div); // Ajoute en haut (le CSS flex-reverse g√®re l'affichage)
}

function toggleButton(text, action, enabled = true) {
    btnNext.innerText = text;
    btnNext.onclick = action;
    btnNext.disabled = !enabled;
    if(!enabled) btnNext.style.display = 'none';
    else btnNext.style.display = 'inline-block';
}

// ======================
// LOGIQUE JEU
// ======================

function appliquerObjet(obj) {
    log(`Objet obtenu : <strong>${obj.nom}</strong>`, "loot");
    
    // Copie de l'objet pour it√©rer sans probl√®mes
    for (const [key, val] of Object.entries(obj)) {
        if (key === "nom" || key === "type" || key === "icon") continue;
        if (key === "capa") {
            if (!joueur.capas.includes(val)) {
                joueur.capas.push(val);
                log(`> Capacit√© apprise: ${val}`);
            }
        } else {
            joueur[key] += val;
        }
    }
    
    // Cap Def
    joueur.def = Math.max(DEF_MIN, joueur.def);

    // Retrait des listes uniques
    if (obj.type === "legendary") {
        objets_legendaires = objets_legendaires.filter(o => o !== obj);
    }
    if (obj.type === "ultra") {
        objets_ultra = objets_ultra.filter(o => o !== obj);
    }
    updateUI();
}

// Phase 1 : Loot du jour
function lootDuJour() {
    // Probabilit√©s : Array de [liste, chance]
    const probs = [
        [objets_communs, 100],
        [objets_communs, 50],
        [objets_rares, 50],
        [objets_legendaires, 2],
        [objets_ultra, 1]
    ];

    let found = false;
    for (let p of probs) {
        let liste = p[0];
        let chance = p[1];
        if (liste.length > 0 && randint(1, 100) <= chance) {
            let obj = choice(liste);
            appliquerObjet(obj);
            found = true;
        }
    }
    if (!found) log("Rien trouv√© ce matin...", "loot");
}

// Combat
async function combat(ennemiData) {
    // Clonage pour ne pas modifier l'original si on veut le r√©utiliser (sauf boss unique)
    let ennemi = {...ennemiData};
    
    log(`COMBAT : ${ennemi.nom} (PV: ${ennemi.pv})`, "combat");
    
    let maxPvEnnemi = ennemi.pv;
    let invincibleTour = joueur.capas.includes("invincible_3tour") ? 3 : 0;
    
    // Affichage barre de boss si c'est un boss
    let isBoss = ennemi.nom.includes("Seigneur") || ennemi.nom.includes("Roi");
    if (isBoss) {
        bossBarContainer.style.display = 'block';
        bossName.innerText = ennemi.nom;
        bossBarFill.style.width = '100%';
    }

    // Boucle de combat "simul√©e" avec des d√©lais pour l'animation
    // On utilise une fonction r√©cursive ou asynchrone pour ne pas figer le navigateur
    
    return new Promise((resolve) => {
        let combatLoop = setInterval(() => {
            // Tour Joueur
            let attaques = 1;
            if (joueur.capas.includes("multi_attaque")) {
                while(randint(1, 2) === 1) attaques++;
            }

            let totalDegats = 0;
            for (let i = 0; i < attaques; i++) {
                let degats = joueur.att * ennemi.def; // Note: Formule originale Python
                // Le syst√®me de d√©fense Python : degats = att * def_ennemi. 
                // Si def_ennemi = 2 (Voleur), joueur prend cher ? 
                // Ah non, att * def -> plus def est haut, plus on fait mal ? 
                // V√©rifions le code Python : "degats = joueur['att'] * ennemi['def']"
                // Voleur def: 2 -> degats x2. Champion def: 1 -> degats x1.
                // C'est un syst√®me "multiplicateur de d√©g√¢ts re√ßus par la cible".
                
                if (joueur.capas.includes("crit_25") && randint(1, 100) <= 25) {
                    degats *= 5;
                    log("CRITIQUE !", "combat");
                }
                
                ennemi.pv -= degats;
                totalDegats += degats;

                if (joueur.capas.includes("vol_de_vie")) {
                    joueur.pv += degats * 0.4;
                }
                if (ennemi.pv <= 0) break;
            }
            
            log(`Vous infligez ${Math.floor(totalDegats)} d√©g√¢ts.`, "combat");
            
            // MAJ Barre Boss
            if (isBoss) {
                let pct = Math.max(0, (ennemi.pv / maxPvEnnemi) * 100);
                bossBarFill.style.width = pct + '%';
            }

            // V√©rif victoire
            if (ennemi.pv <= 0) {
                clearInterval(combatLoop);
                if (isBoss) bossBarContainer.style.display = 'none';
                
                joueur.or += ennemi.or;
                joueur.pv += joueur.regen;
                log(`VICTOIRE ! +${ennemi.or} or. +${joueur.regen} PV regen.`, "success");
                updateUI();
                resolve(true);
                return;
            }

            // Tour Ennemi
            let degatsSubis = ennemi.att * joueur.def;
            if (joueur.capas.includes("reduc_degats")) degatsSubis /= 2;
            
            if (invincibleTour > 0) {
                degatsSubis = 0;
                invincibleTour--;
                log("Invuln√©rable !", "combat");
            }
            
            joueur.pv -= degatsSubis;
            log(`${ennemi.nom} attaque ! -${Math.floor(degatsSubis)} PV.`, "combat");
            updateUI();

            // V√©rif d√©faite
            if (joueur.pv <= 0) {
                clearInterval(combatLoop);
                log("VOUS √äTES MORT...", "combat");
                resolve(false);
                return;
            }

        }, 800); // D√©lai entre chaque tour (ms)
    });
}

// √âv√©nements al√©atoires
const eventsPossibles = [
    { type: 'combat', id: 'voleur' },
    { type: 'combat', id: 'voleur' },
    { type: 'combat', id: 'guerrier' },
    { type: 'combat', id: 'guerrier' },
    { type: 'gain', val: 30, text: "Tu trouves une bourse : +30 or" },
    { type: 'gain', val: 45, text: "Gros tr√©sor ! +45 or" },
    { type: 'heal', val: 10, text: "Rencontre paisible, +10 PV" },
    { type: 'pari_risk' },
    { type: 'pari_win' }
];

async function lancerEvent(day) {
    let pool = [...eventsPossibles];
    if (day >= 5) pool.push({ type: 'combat', id: 'champion' });
    
    let evt = choice(pool);

    if (evt.type === 'combat') {
        return await combat(ennemisData[evt.id]);
    } else if (evt.type === 'gain') {
        log(evt.text, "event");
        joueur.or += evt.val;
    } else if (evt.type === 'heal') {
        log(evt.text, "event");
        joueur.pv += evt.val;
    } else if (evt.type === 'pari_risk') {
        if (randint(1, 2) === 1) {
            joueur.or += 40;
            log("Pari risqu√© gagn√© ! +40 or", "event");
        } else {
            joueur.or -= 20;
            log("Pari risqu√© perdu... -20 or", "event");
        }
    } else if (evt.type === 'pari_win') {
        joueur.or += 40;
        log("Pari chanceux ! +40 or", "event");
    }
    updateUI();
    return true; // Le joueur est vivant (sauf si combat g√©r√© plus haut)
}

// Marchand
function generateMerchantCard(obj, index) {
    const card = document.createElement('div');
    card.className = `card ${obj.type}`;
    card.onclick = () => acheterObjet(obj, card);

    let statsHtml = '';
    for (const [key, val] of Object.entries(obj)) {
        if (["nom", "type", "icon", "capa"].includes(key)) continue;
        statsHtml += `<div>${key.toUpperCase()}: ${val > 0 ? '+' : ''}${val}</div>`;
    }
    
    let capaHtml = obj.capa ? `<div class="capa-tag">${obj.capa}</div>` : '';

    card.innerHTML = `
        <div class="card-icon">${obj.icon}</div>
        <div class="card-title">${obj.nom}</div>
        <div class="card-stats">
            ${statsHtml}
            ${capaHtml}
        </div>
        <div class="card-price">PRIX: 20 OR</div>
    `;
    return card;
}

function ouvrirMarchand() {
    log("Le marchand installe son √©choppe.", "event");
    merchantArea.innerHTML = '';
    merchantArea.style.display = 'flex';
    toggleButton("Quitter le marchand", fermerMarchand);

    // G√©n√©ration du stock
    const probs = [
        [objets_communs, 100],
        [objets_communs, 100],
        [objets_rares, 40],
        [objets_legendaires, 5],
        [objets_ultra, 2]
    ];
    
    for (let p of probs) {
        if (p[0].length > 0 && randint(1, 100) <= p[1]) {
            let item = choice(p[0]);
            merchantArea.appendChild(generateMerchantCard(item));
        }
    }
}

function acheterObjet(obj, cardElement) {
    if (joueur.or >= 20) {
        joueur.or -= 20;
        appliquerObjet(obj);
        // Animation d'achat
        cardElement.style.transform = "scale(0)";
        setTimeout(() => cardElement.remove(), 300);
    } else {
        log("Pas assez d'or !", "event");
        cardElement.style.borderColor = "red";
        setTimeout(() => cardElement.style.borderColor = "", 500);
    }
}

function fermerMarchand() {
    merchantArea.style.display = 'none';
    finDuJour();
}

// ======================
// CONTR√îLEUR GLOBAL
// ======================

async function nextPhase() {
    // Bouton d√©sactiv√© pendant l'action
    toggleButton("...", null, false);

    if (gameState.gameOver) {
        location.reload();
        return;
    }

    log(`===== JOUR ${gameState.day} =====`, "day");

    // 1. Loot
    lootDuJour();
    if (joueur.pv <= 0) return gameOver();

    // 2. Event ou Boss
    let vivant = true;
    if (gameState.day === 10) {
        vivant = await combat(ennemisData["boss10"]);
    } else if (gameState.day === 20) {
        vivant = await combat(ennemisData["boss20"]);
    } else {
        vivant = await lancerEvent(gameState.day);
    }

    if (!vivant) {
        gameOver();
        return;
    }

    // 3. Marchand (sauf si fin du jeu jour 20 gagn√©)
    if (gameState.day === 20 && vivant) {
        victory();
    } else {
        ouvrirMarchand();
    }
}

function finDuJour() {
    gameState.day++;
    updateUI();
    toggleButton(`Lancer Jour ${gameState.day}`, nextPhase);
}

function gameOver() {
    log("‚ò†Ô∏è FIN DE PARTIE ‚ò†Ô∏è", "combat");
    toggleButton("Recommencer", () => location.reload(), true);
    gameState.gameOver = true;
}

function victory() {
    log("üèÜ VOUS AVEZ SURV√âCU AUX 20 JOURS ! üèÜ", "success");
    toggleButton("Nouvelle Aventure", () => location.reload(), true);
    gameState.gameOver = true;
}

// Init
updateUI();

</script>
</body>
</html>
